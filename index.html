<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfecta CRM - V14.1 (Or√ßamentos)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #007bff; --bg: #e9eef2; --text: #333;
            --success: #28a745; --danger: #dc3545; --warning: #ffc107; --info: #17a2b8;
        }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: var(--bg); display: flex; flex-direction: column; height: 100vh; }
        
        nav { background: white; padding: 0 20px; height: 60px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-shrink: 0; z-index: 100; }
        .brand { font-weight: bold; font-size: 1.2rem; color: var(--primary); }
        .nav-buttons button { background: transparent; border: none; padding: 10px 15px; cursor: pointer; border-bottom: 3px solid transparent; color: #666; font-size: 0.95rem; transition: 0.3s; }
        .nav-buttons button:hover { background-color: #f8f9fa; }
        .nav-buttons button.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: bold; }

        .view-section { display: none; flex: 1; overflow: hidden; padding: 20px; }
        .view-section.active { display: flex; flex-direction: column; }
        .management-container { display: flex; gap: 20px; height: 100%; }
        
        .form-area { width: 650px; background: white; padding: 20px; border-radius: 8px; overflow-y: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .list-area { flex: 1; background: white; padding: 20px; border-radius: 8px; display: flex; flex-direction: column; }

        label { font-weight: 600; font-size: 0.85em; display: block; margin-bottom: 4px; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        .contact-info-display { font-size: 0.75em; color: #007bff; margin-top: -10px; margin-bottom: 10px; display: block; min-height: 1em; }

        /* Estilo para Blocos de Obra */
        .obra-section { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee; }
        .pvc-bg { background-color: #f0f7ff; border-left: 5px solid #007bff; }
        .alu-bg { background-color: #fff4e5; border-left: 5px solid #fd7e14; }
        .obra-title { grid-column: span 2; font-weight: bold; font-size: 0.9em; margin-bottom: 5px; color: #444; text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 5px; }

        /* Funil */
        .funnel-filters { background: white; padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; display: flex; gap: 15px; flex-wrap: wrap; font-size: 0.85em; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .funnel-filters label { margin: 0; display: flex; align-items: center; gap: 4px; font-weight: normal; }
        
        .board { display: flex; overflow-x: auto; gap: 10px; height: 100%; align-items: flex-start; }
        .column { background: #f0f2f5; min-width: 210px; width: 210px; border-radius: 8px; display: flex; flex-direction: column; max-height: 100%; }
        .column-header { padding: 10px; font-weight: bold; color: white; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; font-size: 0.9em; }
        .column-body { padding: 8px; flex: 1; overflow-y: auto; }
        
        .col-novo { background: #6c757d; } .col-contatado { background: #17a2b8; } 
        .col-orcamento { background: #ffc107; color:#333 !important; } .col-negociacao { background: #fd7e14; }
        .col-fechado { background: #28a745; } .col-perdido { background: #dc3545; }

        .card { background: white; border-radius: 6px; padding: 10px; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; border-left: 5px solid #ccc; position: relative; }
        .card-blue { background-color: #e3f2fd !important; border-left-color: #2196f3 !important; }
        .card-red { background-color: #ffebee !important; border-left-color: #f44336 !important; }
        .card-yellow { background-color: #fffde7 !important; border-left-color: #fbc02d !important; }
        .card-green { background-color: #e8f5e9 !important; border-left-color: #4caf50 !important; }
        .card-number { position: absolute; top: 8px; right: 8px; font-size: 0.65em; color: #888; font-weight: bold; }
        .card-stars { font-size: 0.8em; margin-bottom: 2px; display: block; color: #ffc107; }
        .card-title { font-weight: bold; display: block; margin-bottom: 4px; margin-right: 30px; font-size: 0.92em; }
        .card-dates { font-size: 0.7em; color: #555; background: rgba(255,255,255,0.6); padding: 4px; border-radius: 4px; line-height: 1.3; }

        .timeline-item { border-left: 3px solid #ddd; padding: 8px 15px; margin-bottom: 10px; border-radius: 0 6px 6px 0; background: #fafafa; position: relative; }
        .seq-badge { position: absolute; left: -12px; top: 0; background: #666; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7em; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .tl-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .stage-tag { background: #333; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7em; text-transform: uppercase; }
        .btn-del-hist { background: none; border: none; cursor: pointer; font-size: 1.1em; color: #dc3545; }

        /* Estilos Arquivos */
        .file-item { display: flex; align-items: center; justify-content: space-between; background: #f8f9fa; padding: 8px; border-radius: 4px; margin-bottom: 5px; border: 1px solid #eee; font-size: 0.85em; }
        .file-name { color: var(--primary); text-decoration: none; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 80%; }
        .file-name:hover { text-decoration: underline; }

        /* Dashboard */
        .dashboard-grid { overflow-y: auto; padding-bottom: 20px; height: 100%; display: flex; flex-direction: column; }
        .filter-bar { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; flex-shrink: 0; }
        .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; flex-shrink: 0; margin-bottom: 15px; }
        .chart-box { background: white; padding: 10px; border-radius: 8px; height: 220px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; }
        .chart-box-wide { grid-column: span 2; height: 300px; }
        .chart-title { font-weight: bold; font-size: 0.85em; margin-bottom: 5px; color: #555; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .metric-badge { position: absolute; top: 35px; right: 15px; background: #ffebee; color: #d32f2f; padding: 4px 8px; border-radius: 4px; font-size: 0.75em; font-weight: bold; }

        .btn-save { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-icon { border: none; background: #eee; padding: 5px 8px; border-radius: 4px; cursor: pointer; font-size: 1.1em; }
        .table-wrapper { flex: 1; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background: #f1f3f5; text-align: left; padding: 10px; position: sticky; top: 0; border-bottom: 2px solid #ddd; color: #444; }
        td { padding: 8px 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover { background-color: #f8f9fa; cursor: pointer; }

        /* Estilos Exclusivos para a nova aba Or√ßamentos/Modal */
        #dialog-apontamento { border: none; border-radius: 8px; padding: 20px; width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        #dialog-apontamento::backdrop { background: rgba(0,0,0,0.5); }
        .readonly-field { background-color: #e9ecef; color: #6c757d; cursor: not-allowed; }
        .hist-list-item { font-size: 0.8em; padding: 8px; border-bottom: 1px solid #eee; background: #fafafa; margin-bottom: 4px; }
        
        /* NOVO: Classe para alinhar bot√µes na tabela */
        .btn-group-row { display: flex; gap: 8px; justify-content: center; align-items: center; white-space: nowrap; }
    </style>
</head>
<body>

    <nav>
        <div class="brand">Perfecta CRM v14.1</div>
        <div class="nav-buttons">
            <button onclick="switchView('funil')" id="btn-funil" class="active">üìä Funil</button>
            <button onclick="switchView('orcamentos')" id="btn-orcamentos">üïê Or√ßamentos</button>
            <button onclick="switchView('leads')" id="btn-leads">üéØ Leads</button>
            <button onclick="switchView('cadastro')" id="btn-cadastro">üë• Cadastro</button>
            <button onclick="switchView('atendentes')" id="btn-atendentes">üíº Atendentes</button>
            <button onclick="switchView('dashboard')" id="btn-dashboard">üìà Dashboard</button>
        </div>
    </nav>

    <section id="view-funil" class="view-section active">
        <div class="funnel-filters">
            <button onclick="novoLeadDireto()" style="background:#28a745; color:white; border:none; padding:6px 12px; border-radius:4px; font-weight:bold; cursor:pointer;">+ Novo</button>
            <label>Atendente: <select id="f-funil-atend" onchange="renderFunnel()" style="margin:0; width:110px; padding:4px;"><option value="todos">Todos</option></select></label>
            <label>üìÖ De: <input type="date" id="f-funil-ini" onchange="renderFunnel()" style="margin:0; width:110px; padding:2px;"></label>
            <label>At√©: <input type="date" id="f-funil-fim" onchange="renderFunnel()" style="margin:0; width:110px; padding:2px;"></label>
            <label>Realizado: 
                <select id="f-funil-real" onchange="renderFunnel()" style="margin:0; padding:4px;">
                    <option value="todos">Todos</option>
                    <option value="com">Sim</option>
                    <option value="sem" selected>N√£o</option>
                </select>
            </label>
            <div style="display:flex; gap:8px;">
                <label><input type="checkbox" checked onchange="toggleStarFilter(1)"> 1‚≠ê</label>
                <label><input type="checkbox" checked onchange="toggleStarFilter(2)"> 2‚≠ê</label>
                <label><input type="checkbox" checked onchange="toggleStarFilter(3)"> 3‚≠ê</label>
            </div>
            <label style="margin-left:10px; border-left:1px solid #ddd; padding-left:15px; color:var(--primary); font-weight:bold;">
                <input type="checkbox" id="f-funil-all" onchange="renderFunnel()" checked> Exibir Hist√≥rico Completo
            </label>
        </div>
        <div class="board">
            <div id="w-novo" class="column"><div class="column-header col-novo">Novos <span id="c-novo">0</span></div><div class="column-body" id="list-novo"></div></div>
            <div id="w-contatado" class="column"><div class="column-header col-contatado">Contato <span id="c-contatado">0</span></div><div class="column-body" id="list-contatado"></div></div>
            <div id="w-orcamento" class="column"><div class="column-header col-orcamento">Or√ßamento <span id="c-orcamento">0</span></div><div class="column-body" id="list-orcamento"></div></div>
            <div id="w-negociacao" class="column"><div class="column-header col-negociacao">Negocia√ß√£o <span id="c-negociacao">0</span></div><div class="column-body" id="list-negociacao"></div></div>
            <div id="w-fechado" class="column"><div class="column-header col-fechado">Fechados <span id="c-fechado">0</span></div><div class="column-body" id="list-fechado"></div></div>
            <div id="w-perdido" class="column"><div class="column-header col-perdido">Perdidos <span id="c-perdido">0</span></div><div class="column-body" id="list-perdido"></div></div>
        </div>
    </section>

    <section id="view-orcamentos" class="view-section">
        <div class="management-container">
            <div class="form-area" style="width: 450px;">
                <h2>üïê Gest√£o de Or√ßamentos</h2>
                <form id="form-orcamento">
                    <input type="hidden" id="orc-id">
                    
                    <label>Lead *</label>
                    <select id="orc-lead" required onchange="populateHistSelect(this.value)"><option value="">Selecione...</option></select>

                    <label>N√∫mero do Hist√≥rico (Ref. Lead) *</label>
                    <select id="orc-hist-num" required><option value="">Selecione o Lead...</option></select>

                    <label>Atendente (Dono do Or√ßamento) *</label>
                    <select id="orc-atendente" required><option value="">Selecione...</option></select>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <label>Data/Hora Solicitado</label>
                            <input type="datetime-local" id="orc-solicitado" readonly class="readonly-field" title="Gerado automaticamente na cria√ß√£o">
                        </div>
                        <div>
                            <label>Prazo Final</label>
                            <input type="datetime-local" id="orc-prazo">
                        </div>
                    </div>

                    <label>Status Atual (Autom√°tico via Apontamentos)</label>
                    <input type="text" id="orc-status-display" readonly class="readonly-field" value="Programado">
                    <input type="hidden" id="orc-status-value" value="Programado">

                    <label>Observa√ß√£o Geral</label>
                    <textarea id="orc-obs" style="height: 80px;"></textarea>

                    <button type="submit" class="btn-save">Salvar Or√ßamento</button>
                    <button type="button" onclick="limparFormOrcamento()" style="width:100%; margin-top:5px; padding:8px; background:#6c757d; color:white; border:none; border-radius:6px; cursor:pointer;">Limpar / Novo</button>
                </form>
            </div>
            <div class="list-area">
                <h2>Lista de Or√ßamentos</h2>
                <div style="display:flex; gap:10px; margin-bottom:15px; background:#f8f9fa; padding:10px; border-radius:6px; border:1px solid #eee; align-items:flex-end;">
                    <div style="flex:1"><label>Filtro Atendente</label><select id="f-orc-atend" onchange="renderTableOrcamentos()" style="margin:0"><option value="todos">Todos</option></select></div>
                    <div style="flex:1"><label>Filtro Status</label>
                        <select id="f-orc-status" onchange="renderTableOrcamentos()" style="margin:0">
                            <option value="todos">Todos</option>
                            <option value="Programado">Programado</option>
                            <option value="Iniciado">Iniciado</option>
                            <option value="Paralizado">Paralizado</option>
                            <option value="Conclu√≠do">Conclu√≠do</option>
                            <option value="Revisado">Revisado</option>
                        </select>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table id="table-orcamentos">
                        <thead>
                            <tr>
                                <th>Lead</th>
                                <th>Atendente</th>
                                <th>Status</th>
                                <th>Prazo Final</th>
                                <th style="width:140px; text-align:center;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <dialog id="dialog-apontamento">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <h3 style="margin:0">‚è±Ô∏è Apontamento no Or√ßamento</h3>
                <button onclick="document.getElementById('dialog-apontamento').close()" style="border:none; background:none; font-size:1.5em; cursor:pointer;">&times;</button>
            </div>
            <div id="modal-info-lead" style="font-weight:bold; color:var(--primary); margin-bottom:10px; font-size:0.9em;"></div>
            
            <form id="form-apontamento-item">
                <input type="hidden" id="apt-orc-id"> <input type="hidden" id="apt-index-editing" value="-1"> <label>Atendente *</label>
                <select id="apt-atendente" required></select>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div>
                        <label>Dia/Hora In√≠cio *</label>
                        <input type="datetime-local" id="apt-inicio" onchange="checkRegistro('inicio')">
                    </div>
                    <div>
                        <label>Registro In√≠cio (Auto)</label>
                        <input type="text" id="apt-reg-inicio" readonly class="readonly-field" placeholder="Autom√°tico...">
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div>
                        <label>Dia/Hora Fim</label>
                        <input type="datetime-local" id="apt-fim" onchange="checkRegistro('fim')">
                    </div>
                    <div>
                        <label>Registro Fim (Auto)</label>
                        <input type="text" id="apt-reg-fim" readonly class="readonly-field" placeholder="Autom√°tico...">
                    </div>
                </div>

                <label>Status * (Proibido 'Programado')</label>
                <select id="apt-status" required>
                    <option value="Programado" disabled>Programado</option>
                    <option value="Iniciado">Iniciado</option>
                    <option value="Paralizado">Paralizado</option>
                    <option value="Conclu√≠do">Conclu√≠do</option>
                    <option value="Revisado">Revisado</option>
                </select>

                <label>Observa√ß√µes</label>
                <textarea id="apt-obs" style="height:60px;"></textarea>

                <button type="submit" class="btn-save" style="background:#17a2b8; margin-top:10px;">Gravar Apontamento</button>
            </form>

            <div style="margin-top:20px; border-top:2px solid #eee; padding-top:10px;">
                <h4 style="margin:0 0 10px 0; font-size:0.9em;">Hist√≥rico deste Or√ßamento</h4>
                <div id="lista-historico-apontamentos" style="max-height:150px; overflow-y:auto;"></div>
            </div>
        </dialog>
    </section>

    <section id="view-leads" class="view-section">
        <div class="management-container">
            <div class="form-area">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h2>Dados B√°sicos</h2>
                    <button onclick="limparFormLead()" style="padding:5px 10px; cursor:pointer;">Limpar / Novo</button>
                </div>
                <form id="form-lead-main">
                    <input type="hidden" id="lead-id">
                    <label>Cliente *</label>
                    <select id="lead-cliente" required onchange="showInfo('cliente', this.value)"><option value="">Carregando...</option></select>
                    <span id="info-cliente" class="contact-info-display"></span>

                    <label>Origem *</label>
                    <select id="lead-origem" required>
                        <option>Instagram</option><option>Tiktok</option><option>Facebook</option><option>Site</option><option>Google</option>
                        <option>Prospec√ß√£o</option><option>Indica√ß√£o</option><option>Reativa√ß√£o</option><option>Outros</option>
                    </select>

                    <label>Indica√ß√£o</label>
                    <select id="lead-indicacao" onchange="showInfo('indicacao', this.value)"><option value="">Selecione...</option></select>
                    <span id="info-indicacao" class="contact-info-display"></span>

                    <div class="obra-section pvc-bg">
                        <div class="obra-title">Obra PVC</div>
                        <div><label>Metragem (m¬≤)</label><input type="text" id="lead-pvc-metragem" class="mask-m2"></div>
                        <div><label>Qtd Pe√ßas</label><input type="number" id="lead-pvc-pecas"></div>
                        <div><label>Margem Padr√£o (%)</label><input type="text" id="lead-pvc-margem-padrao" class="mask-percent"></div>
                        <div><label>Margem Especial (%)</label><input type="text" id="lead-pvc-margem-especial" class="mask-percent"></div>
                        <div><label>Valor Or√ßamento (R$)</label><input type="text" id="lead-pvc-valor-orcamento" class="mask-currency"></div>
                        <div><label>Valor Pedido (R$)</label><input type="text" id="lead-pvc-valor-pedido" class="mask-currency"></div>
                    </div>

                    <div class="obra-section alu-bg">
                        <div class="obra-title">Obra Alum√≠nio</div>
                        <div><label>Metragem (m¬≤)</label><input type="text" id="lead-alu-metragem" class="mask-m2"></div>
                        <div><label>Qtd Pe√ßas</label><input type="number" id="lead-alu-pecas"></div>
                        <div><label>Margem Padr√£o (%)</label><input type="text" id="lead-alu-margem-padrao" class="mask-percent"></div>
                        <div><label>Margem Especial (%)</label><input type="text" id="lead-alu-margem-especial" class="mask-percent"></div>
                        <div><label>Valor Or√ßamento (R$)</label><input type="text" id="lead-alu-valor-orcamento" class="mask-currency"></div>
                        <div><label>Valor Pedido (R$)</label><input type="text" id="lead-alu-valor-pedido" class="mask-currency"></div>
                    </div>

                    <label>Previs√£o Instala√ß√£o</label><input type="date" id="lead-previsao">
                    
                    <label>Construtora</label>
                    <select id="lead-construtora" onchange="showInfo('construtora', this.value)"><option value="">Selecione...</option></select>
                    <span id="info-construtora" class="contact-info-display"></span>

                    <label>Adm da Obra</label>
                    <select id="lead-adm-obra" onchange="showInfo('adm-obra', this.value)"><option value="">Selecione...</option></select>
                    <span id="info-adm-obra" class="contact-info-display"></span>

                    <label>Arquiteto</label>
                    <select id="lead-arquiteto" onchange="showInfo('arquiteto', this.value)"><option value="">Selecione...</option></select>
                    <span id="info-arquiteto" class="contact-info-display"></span>

                    <label>Respons√°vel Obra</label>
                    <select id="lead-responsavel" onchange="showInfo('responsavel', this.value)"><option value="">Selecione...</option></select>
                    <span id="info-responsavel" class="contact-info-display"></span>

                    <button type="submit" class="btn-save">Salvar Dados B√°sicos</button>
                </form>

                <div id="area-arquivos" style="display:none; margin-top:20px;">
                    <hr><h3>üìÅ Arquivos</h3>
                    <input type="file" id="lead-file-input" style="display:none" onchange="handleFileUpload(this.files)">
                    <button type="button" onclick="document.getElementById('lead-file-input').click()" class="btn-save" style="background:#6c757d; margin-bottom:10px;">+ Upload de Arquivo</button>
                    <div id="lead-files-list"></div>
                </div>

                <div id="area-historico" style="display:none; margin-top:20px;">
                    <hr><h3>üìú Hist√≥rico</h3>
                    <form id="form-historico" style="background:#f9f9f9; padding:10px; border-radius:6px; border:1px solid #eee;">
                        <input type="hidden" id="hist-index" value="">
                        <label>Atendente *</label><select id="hist-atendente" required></select>
                        
                        <label>Contato *</label>
                        <select id="hist-contato-tipo" required onchange="handleHistContato(this.value)">
                            <option value="">Selecione...</option>
                            <option value="Propriet√°rio">Propriet√°rio</option>
                            <option value="Arquiteto">Arquiteto</option>
                            <option value="Respons√°vel Obra">Respons√°vel Obra</option>
                            <option value="Adm Obra">Adm Obra</option>
                            <option value="Construtora">Construtora</option>
                            <option value="Outra">Outra</option>
                        </select>
                        <div id="area-contato-outra" style="display:none">
                            <label>Selecionar Cadastro</label>
                            <select id="hist-contato-id" onchange="updateHistContactDisplay(this.value)"></select>
                        </div>
                        <span id="info-hist-contato" class="contact-info-display" style="color: #28a745; font-weight: bold;"></span>

                        <label>Etapa *</label><select id="hist-etapa" required><option value="novo">Novo</option><option value="contatado">Contato</option><option value="orcamento">Or√ßamento</option><option value="negociacao">Negocia√ß√£o</option><option value="fechado">Fechado</option><option value="perdido">Perdido</option></select>
                        <label>Classifica√ß√£o</label>
                        <select id="hist-temp">
                            <option value="">Sem estrelas</option>
                            <option value="1">‚≠ê 1 Estrela</option>
                            <option value="2">‚≠ê‚≠ê 2 Estrelas</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê 3 Estrelas</option>
                        </select>
                        <div style="display:flex; gap:10px;">
                            <div style="flex:1"><label>Programado</label><input type="datetime-local" id="hist-prog"></div>
                            <div style="flex:1"><label>Realizado</label><input type="datetime-local" id="hist-real"></div>
                        </div>

                        <label>Resultado da Intera√ß√£o *</label>
                        <select id="hist-resultado">
                            <option value="">Selecione...</option>
                            <option value="Sucesso">Sucesso</option>
                            <option value="Insucesso">Insucesso</option>
                        </select>
                        
                        <label>√öltima altera√ß√£o 'Realizado'</label>
                        <input type="text" id="hist-upd-real" readonly style="background:#f0f0f0; color:#666; font-size:0.85em;">

                        <label>Resumo</label><textarea id="hist-resumo" required style="height:60px;"></textarea>
                        <button type="submit" class="btn-save" style="background:#17a2b8" id="btn-save-hist">+ Gravar Intera√ß√£o</button>
                    </form>
                    <div id="timeline-list" style="margin-top:15px;"></div>
                </div>
            </div>
            <div class="list-area">
                <h2>Leads</h2>
                <div class="table-wrapper">
                    <table id="table-leads">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Desde</th>
                                <th>Cliente</th>
                                <th>Etapa</th>
                                <th style="width:110px">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <section id="view-cadastro" class="view-section">
        <div class="management-container">
            <div class="form-area" style="width:400px;">
                <h2>Novo Registro</h2>
                <form id="form-cliente">
                    <input type="hidden" id="cli-id">
                    <label>Nome *</label><input type="text" id="cli-nome" required>
                    <label>Tipo *</label>
                    <select id="cli-tipo" required>
                        <option>Cliente</option><option>Arquiteto</option><option>Respons√°vel Obra</option>
                        <option>Construtora</option><option>Adm da Obra</option><option>Outro</option>
                    </select>
                    <label>Status</label><select id="cli-status"><option>Novo</option><option>Ativo</option><option>Inativo</option></select>
                    <label>Telefone/Whats</label><input type="text" id="cli-telefone" placeholder="(99) 99999-9999">
                    <label>E-mail</label><input type="email" id="cli-email">
                    <label>Cidade</label><input type="text" id="cli-cidade">
                    <label>Endere√ßo</label><input type="text" id="cli-endereco">
                    <button type="submit" class="btn-save">Salvar</button>
                </form>
            </div>
            <div class="list-area"><h2>Cadastro Geral</h2><div class="table-wrapper"><table id="table-clientes"><thead><tr><th>Nome</th><th>Tipo</th><th>Cidade</th><th style="width:80px;">A√ß√µes</th></tr></thead><tbody></tbody></table></div></div>
        </div>
    </section>

    <section id="view-atendentes" class="view-section">
        <div class="management-container">
            <div class="form-area" style="width:400px;">
                <h2>Equipe</h2>
                <form id="form-atendente">
                    <input type="hidden" id="atend-id">
                    <label>Nome *</label><input type="text" id="atend-nome" required>
                    <label>Email</label><input type="email" id="atend-email" required>
                    <label>Whats</label><input type="text" id="atend-whats" placeholder="(99) 99999-9999">
                    <button type="submit" class="btn-save">Salvar</button>
                </form>
            </div>
            <div class="list-area"><h2>Atendentes</h2><div class="table-wrapper"><table id="table-atendentes"><thead><tr><th>Nome</th><th>Whats</th><th style="width:80px;">A√ß√µes</th></tr></thead><tbody></tbody></table></div></div>
        </div>
    </section>

    <section id="view-dashboard" class="view-section">
        <div class="dashboard-grid">
            <div class="filter-bar">
                <div class="filter-group"><label>In√≠cio</label><input type="date" id="dash-inicio"></div>
                <div class="filter-group"><label>Fim</label><input type="date" id="dash-fim"></div>
                <div class="filter-group"><label>Atendente</label><select id="dash-atendente"><option value="todos">Todos</option></select></div>
                <button class="btn-save" style="width:auto; height:42px; padding:0 20px;" onclick="processarDashboard()">Atualizar</button>
            </div>

            <div class="charts-container">
                <div class="chart-box">
                    <div class="chart-title">üìç Leads por Origem</div>
                    <canvas id="chartOrigem"></canvas>
                </div>
                <div class="chart-box">
                    <div class="chart-title">üìÖ Novos Leads (Por Dia)</div>
                    <canvas id="chartLeadsDay"></canvas>
                </div>
                <div class="chart-box">
                    <div class="chart-title">‚è±Ô∏è Performance e Atraso M√©dio</div>
                    <div id="delay-metric" class="metric-badge" style="display:none"></div>
                    <canvas id="chartPerformance"></canvas>
                </div>
                <div class="chart-box">
                    <div class="chart-title">‚è≥ M√©dia de Dias por Etapa</div>
                    <canvas id="chartStageTime"></canvas>
                </div>
                <div class="chart-box chart-box-wide">
                    <div class="chart-title">üöÄ Evolu√ß√£o: Tempo para Mudar de Etapa (M√©dias)</div>
                    <canvas id="chartCycleTime"></canvas>
                </div>
            </div>

            <div class="list-area" style="min-height:300px; margin-top:15px; flex:none;">
                <h3 style="margin:0 0 10px 0">üìã Relat√≥rio Filtrado <span id="dash-count" style="font-size:0.8em; font-weight:normal; color:#666"></span></h3>
                <div class="table-wrapper">
                    <table id="dash-table">
                        <thead><tr><th>Data</th><th>Etapa</th><th>#Lead</th><th>Cliente</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

        const firebaseConfig = { apiKey: "AIzaSyDxikX_gLL3l2fQuHmSZUai5-1CgBGp2ao", authDomain: "orcamento-80415.firebaseapp.com", projectId: "orcamento-80415", storageBucket: "orcamento-80415.firebasestorage.app", messagingSenderId: "767008319616", appId: "1:767008319616:web:78b45f56f92ce7a5091e65" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let listaLeads=[], listaClientes=[], listaAtendentes=[], listaOrcamentos=[], leadAtual=null, orcamentoAtual=null, starFilters=[1,2,3];
        let chartOrigem=null, chartLeadsDay=null, chartPerf=null, chartStageTime=null, chartCycleTime=null;

        function formatBR(iso) { if(!iso) return '-'; const d=new Date(iso); return d.toLocaleDateString('pt-BR')+' '+d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}); }
        
        // --- L√ìGICA DE M√ÅSCARAS ---
        const cleanNum = (v) => v.replace(/\D/g, "");

        const applyMasks = () => {
            document.querySelectorAll('.mask-m2').forEach(el => {
                el.addEventListener('input', (e) => {
                    let v = e.target.value.replace(/[^\d,]/g, "");
                    const parts = v.split(",");
                    if (parts.length > 2) v = parts[0] + "," + parts[1];
                    e.target.value = v;
                });
                el.addEventListener('blur', (e) => {
                    let v = e.target.value.replace(/[^\d,]/g, "");
                    if (!v) return;
                    let num = parseFloat(v.replace(",", "."));
                    if (!isNaN(num)) {
                        e.target.value = num.toLocaleString('pt-BR', {minimumFractionDigits: 1, maximumFractionDigits: 1}) + " m2";
                    }
                });
                el.addEventListener('focus', (e) => {
                    e.target.value = e.target.value.replace(" m2", "");
                });
            });

            document.querySelectorAll('.mask-percent').forEach(el => {
                el.addEventListener('input', (e) => { e.target.value = cleanNum(e.target.value); });
                el.addEventListener('blur', (e) => { if (e.target.value && !e.target.value.includes("%")) { e.target.value = e.target.value + "%"; } });
                el.addEventListener('focus', (e) => { e.target.value = e.target.value.replace("%", ""); });
            });

            document.querySelectorAll('.mask-currency').forEach(el => {
                el.addEventListener('input', (e) => { e.target.value = cleanNum(e.target.value); });
                el.addEventListener('blur', (e) => {
                    let v = cleanNum(e.target.value);
                    if (!v) return;
                    let num = parseInt(v);
                    e.target.value = "R$ " + num.toLocaleString('pt-BR');
                });
                el.addEventListener('focus', (e) => { e.target.value = cleanNum(e.target.value); });
            });
        };

        const maskPhone = (v) => {
            v = v.replace(/\D/g, "");
            if (v.length > 11) v = v.substring(0, 11);
            v = v.replace(/^(\d{2})(\d)/g, "($1) $2");
            v = v.replace(/(\d{5})(\d)/, "$1-$2");
            return v;
        };

        document.querySelectorAll('input[id$="telefone"], input[id$="whats"]').forEach(el => {
            el.addEventListener('input', (e) => e.target.value = maskPhone(e.target.value));
        });

        window.showInfo = (field, id) => {
            const span = document.getElementById('info-' + field);
            const item = listaClientes.find(c => c.id === id);
            span.innerText = item ? `üìû ${item.telefone || '-'} | üìß ${item.email || '-'}` : "";
        };

        // --- LISTENERS FIREBASE ---

        onSnapshot(collection(db, "atendentes"), (snap) => {
            listaAtendentes = snap.docs.map(d => ({...d.data(), id: d.id})).sort((a,b) => a.nome.localeCompare(b.nome));
            const tb = document.querySelector('#table-atendentes tbody'); tb.innerHTML = '';
            
            // Popula selects de Atendentes
            const selects = ['hist-atendente', 'f-funil-atend', 'dash-atendente', 'orc-atendente', 'f-orc-atend', 'apt-atendente'];
            selects.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    const firstOption = el.querySelector('option');
                    el.innerHTML = '';
                    if(firstOption) el.appendChild(firstOption);
                }
            });

            listaAtendentes.forEach(a => {
                tb.innerHTML += `<tr onclick="editarAtend('${a.id}')" style="cursor:pointer"><td>${a.nome}</td><td>${a.whats||'-'}</td><td><button class="btn-icon" onclick="event.stopPropagation(); editarAtend('${a.id}')">‚úèÔ∏è</button> <button class="btn-icon" onclick="event.stopPropagation(); excluirAtend('${a.id}')" style="color:red">üóëÔ∏è</button></td></tr>`;
                const opt = `<option value="${a.nome}">${a.nome}</option>`;
                selects.forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML += opt; });
            });
        });

        onSnapshot(collection(db, "clientes"), (snap) => {
            listaClientes = snap.docs.map(d => ({...d.data(), id: d.id})).sort((a,b) => a.nome_empresa.localeCompare(b.nome_empresa));
            const tb = document.querySelector('#table-clientes tbody'); tb.innerHTML = '';
            const selects = ['lead-cliente', 'lead-indicacao', 'lead-construtora', 'lead-adm-obra', 'lead-arquiteto', 'lead-responsavel', 'hist-contato-id'];
            selects.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.innerHTML = '<option value="">Selecione...</option>';
            });
            listaClientes.forEach(c => {
                tb.innerHTML += `<tr onclick="editarCli('${c.id}')" style="cursor:pointer"><td>${c.nome_empresa}</td><td>${c.tipo||'Cliente'}</td><td>${c.cidade||''}</td><td><button class="btn-icon" onclick="event.stopPropagation(); editarCli('${c.id}')">‚úèÔ∏è</button> <button class="btn-icon" onclick="event.stopPropagation(); excluirCli('${c.id}')" style="color:red">üóëÔ∏è</button></td></tr>`;
                const opt = `<option value="${c.id}">${c.nome_empresa}</option>`;
                selects.forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML += opt; });
            });
            renderTableLeads();
        });

        onSnapshot(query(collection(db, "leads"), orderBy("created_at", "desc")), (snap) => {
            listaLeads = snap.docs.map(d => ({...d.data(), id: d.id}));
            renderFunnel(); renderTableLeads();
            const selOrcLead = document.getElementById('orc-lead');
            selOrcLead.innerHTML = '<option value="">Selecione...</option>';
            listaLeads.forEach(l => { selOrcLead.innerHTML += `<option value="${l.id}">${l.numero_lead} - ${l.nome_cliente_cache}</option>`; });
            
            if(document.getElementById('view-dashboard').classList.contains('active')) processarDashboard();
            if(leadAtual) {
                const updated = listaLeads.find(l => l.id === leadAtual.id);
                if(updated) { leadAtual = updated; renderArquivos(); renderTimeline(); }
            }
        });

        onSnapshot(query(collection(db, "apontamentos"), orderBy("updated_at", "desc")), (snap) => {
            listaOrcamentos = snap.docs.map(d => ({...d.data(), id: d.id}));
            renderTableOrcamentos();
            
            // Se o modal estiver aberto, atualiza a lista de hist√≥rico
            if(document.getElementById('dialog-apontamento').open && orcamentoAtual) {
                const updatedOrc = listaOrcamentos.find(o => o.id === orcamentoAtual.id);
                if(updatedOrc) {
                    orcamentoAtual = updatedOrc;
                    renderHistoricoApontamentosNoModal();
                }
            }
        });

        // --- FUNCIONALIDADES OR√áAMENTOS & APONTAMENTOS ---

        window.populateHistSelect = (leadId) => {
            const sel = document.getElementById('orc-hist-num');
            sel.innerHTML = '<option value="">Selecione...</option>';
            const lead = listaLeads.find(l => l.id === leadId);
            if(lead && lead.historico) {
                lead.historico.forEach((h, idx) => {
                    sel.innerHTML += `<option value="${idx + 1}">Hist√≥rico #${idx + 1} (${h.etapa})</option>`;
                });
            }
        };

        document.getElementById('form-orcamento').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('orc-id').value;
            const now = new Date();
            
            const data = {
                atendente: document.getElementById('orc-atendente').value,
                lead_id: document.getElementById('orc-lead').value,
                hist_num: document.getElementById('orc-hist-num').value,
                data_prazo: document.getElementById('orc-prazo').value,
                observacoes: document.getElementById('orc-obs').value,
                updated_at: serverTimestamp()
            };

            if(!id) {
                const offset = now.getTimezoneOffset() * 60000; 
                const localISOTime = (new Date(now - offset)).toISOString().slice(0, 16);
                data.data_solicitado = localISOTime;
                data.status = "Programado"; 
                data.historico_trabalhos = []; 
                await addDoc(collection(db, "apontamentos"), data);
                alert("Or√ßamento criado com sucesso!");
            } else {
                await updateDoc(doc(db, "apontamentos", id), data);
                alert("Or√ßamento atualizado!");
            }
            limparFormOrcamento();
        };

        window.renderTableOrcamentos = () => {
            const tb = document.querySelector('#table-orcamentos tbody');
            const fAtend = document.getElementById('f-orc-atend').value;
            const fStatus = document.getElementById('f-orc-status').value;
            tb.innerHTML = '';
            
            listaOrcamentos.forEach(orc => {
                if(fAtend !== 'todos' && orc.atendente !== fAtend) return;
                if(fStatus !== 'todos' && orc.status !== fStatus) return;
                
                const lead = listaLeads.find(l => l.id === orc.lead_id);
                const statusCor = orc.status === 'Programado' ? '#6c757d' : (orc.status === 'Conclu√≠do' ? '#28a745' : '#17a2b8');
                
                tb.innerHTML += `
                    <tr onclick="editarOrcamento('${orc.id}')">
                        <td>${lead ? lead.numero_lead : 'N/A'} - ${lead ? lead.nome_cliente_cache : ''}</td>
                        <td>${orc.atendente}</td>
                        <td><span class="stage-tag" style="background:${statusCor}">${orc.status}</span></td>
                        <td>${formatBR(orc.data_prazo)}</td>
                        <td style="text-align:center;">
                            <div class="btn-group-row">
                                <button class="btn-icon" onclick="event.stopPropagation(); abrirApontamento('${orc.id}')" title="Apontar Horas/Status">üïí</button>
                                <button class="btn-icon" onclick="event.stopPropagation(); abrirLeadDoOrcamento('${orc.id}')" title="Ir para o Lead">üéØ</button>
                                <span style="margin:0 2px; color:#ddd">|</span>
                                <button class="btn-icon" onclick="event.stopPropagation(); editarOrcamento('${orc.id}')" title="Editar Or√ßamento">‚úèÔ∏è</button>
                                <button class="btn-icon" onclick="event.stopPropagation(); excluirOrcamento('${orc.id}')" style="color:red" title="Excluir Or√ßamento">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>`;
            });
        };

        window.abrirLeadDoOrcamento = (orcId) => {
            const orc = listaOrcamentos.find(x => x.id === orcId);
            if(orc && orc.lead_id) {
                editarLead(orc.lead_id);
            } else {
                alert("Or√ßamento sem lead vinculado.");
            }
        };

        window.editarOrcamento = (id) => {
            const orc = listaOrcamentos.find(x => x.id === id);
            document.getElementById('orc-id').value = orc.id;
            document.getElementById('orc-lead').value = orc.lead_id;
            populateHistSelect(orc.lead_id);
            document.getElementById('orc-hist-num').value = orc.hist_num;
            document.getElementById('orc-atendente').value = orc.atendente;
            document.getElementById('orc-solicitado').value = orc.data_solicitado || '';
            document.getElementById('orc-prazo').value = orc.data_prazo || '';
            document.getElementById('orc-status-display').value = orc.status;
            document.getElementById('orc-obs').value = orc.observacoes || '';
        };

        window.limparFormOrcamento = () => {
            document.getElementById('form-orcamento').reset();
            document.getElementById('orc-id').value = '';
            document.getElementById('orc-status-display').value = "Programado (Novo)";
        };

        window.excluirOrcamento = async (id) => {
            if(confirm("Excluir este Or√ßamento e todo seu hist√≥rico?")) await deleteDoc(doc(db, "apontamentos", id));
        };

        // --- L√ìGICA DO MODAL DE APONTAMENTOS (FILHO) ---

        window.abrirApontamento = (id) => {
            orcamentoAtual = listaOrcamentos.find(x => x.id === id);
            if(!orcamentoAtual) return;

            const lead = listaLeads.find(l => l.id === orcamentoAtual.lead_id);
            document.getElementById('modal-info-lead').innerText = `Lead: ${lead ? lead.numero_lead : '?'} | Cliente: ${lead ? lead.nome_cliente_cache : '?'}`;
            document.getElementById('apt-orc-id').value = id;
            
            limparFormApontamentoItem();
            const historico = orcamentoAtual.historico_trabalhos || [];
            const ultimoApont = historico.length > 0 ? historico[historico.length - 1] : null;

            // Verificar se o √∫ltimo apontamento est√° "aberto" (Tem In√≠cio mas n√£o tem Fim)
            let abrirEmModoEdicao = false;
            
            if (ultimoApont) {
                const temInicio = ultimoApont.inicio && ultimoApont.inicio !== "";
                const temFim = ultimoApont.fim && ultimoApont.fim !== "";
                
                if (temInicio && !temFim) {
                    abrirEmModoEdicao = true;
                }
            }

            if (abrirEmModoEdicao) {
                // Modo: Fechar o apontamento anterior
                const idx = historico.length - 1;
                document.getElementById('apt-index-editing').value = idx;
                
                document.getElementById('apt-atendente').value = ultimoApont.atendente;
                document.getElementById('apt-inicio').value = ultimoApont.inicio;
                document.getElementById('apt-reg-inicio').value = ultimoApont.reg_inicio || "";
                document.getElementById('apt-reg-inicio').setAttribute('data-real-value', ultimoApont.reg_inicio || ""); // Preserva original
                
                document.getElementById('apt-fim').value = ""; // Usu√°rio deve preencher
                document.getElementById('apt-reg-fim').value = "";
                
                document.getElementById('apt-status').value = ultimoApont.status;
                document.getElementById('apt-obs').value = ultimoApont.obs || "";

                alert("O apontamento anterior est√° em aberto. Por favor, encerre-o preenchendo a Data/Hora Fim.");
            } else {
                // Modo: Novo Apontamento
                document.getElementById('apt-index-editing').value = "-1";
                
                // Sugere atendente
                let defaultAtendente = orcamentoAtual.atendente;
                if(ultimoApont) defaultAtendente = ultimoApont.atendente;
                document.getElementById('apt-atendente').value = defaultAtendente;
            }

            renderHistoricoApontamentosNoModal();
            document.getElementById('dialog-apontamento').showModal();
        };

        window.checkRegistro = (tipo) => {
            const campoData = document.getElementById('apt-' + tipo).value;
            const campoReg = document.getElementById('apt-reg-' + tipo);
            
            // S√≥ atualiza visualmente se n√£o estiver editando um registro que j√° tinha valor salvo
            const existingVal = campoReg.getAttribute('data-real-value');
            
            if(campoData && !existingVal) {
                if(!campoReg.value) {
                    const now = new Date();
                    campoReg.value = now.toLocaleString('pt-BR') + " (Ser√° salvo)";
                }
            }
        };

        document.getElementById('form-apontamento-item').onsubmit = async (e) => {
            e.preventDefault();
            
            // Valida√ß√µes
            const inicioVal = document.getElementById('apt-inicio').value;
            if (!inicioVal) {
                alert("O campo Dia/Hora In√≠cio √© obrigat√≥rio.");
                return;
            }

            const statusVal = document.getElementById('apt-status').value;
            if (statusVal === 'Programado') {
                alert("N√£o √© permitido salvar com o status 'Programado'. Selecione Iniciado, Conclu√≠do, etc.");
                return;
            }

            const orcId = document.getElementById('apt-orc-id').value;
            const indexEditing = parseInt(document.getElementById('apt-index-editing').value);
            const now = new Date().toLocaleString('pt-BR');

            // Preparar objeto do item
            const item = {
                atendente: document.getElementById('apt-atendente').value,
                inicio: document.getElementById('apt-inicio').value,
                // Se j√° tinha reg_inicio salvo (edi√ß√£o), mant√©m. Se n√£o, usa o hidden data ou data atual
                reg_inicio: document.getElementById('apt-reg-inicio').getAttribute('data-real-value') || now, 
                fim: document.getElementById('apt-fim').value,
                reg_fim: document.getElementById('apt-reg-fim').getAttribute('data-real-value') || (document.getElementById('apt-fim').value ? now : ""),
                status: statusVal,
                obs: document.getElementById('apt-obs').value,
                timestamp: new Date().toISOString() // Metadata
            };

            // Atualiza array do Or√ßamento
            let historico = orcamentoAtual.historico_trabalhos || [];

            if (indexEditing >= 0) {
                // Atualizando item existente (fechando o aberto)
                // Preserva o reg_inicio original se existir no objeto antigo, caso a l√≥gica acima falhe
                if(historico[indexEditing].reg_inicio) item.reg_inicio = historico[indexEditing].reg_inicio;
                historico[indexEditing] = item;
            } else {
                // Adicionando novo
                historico.push(item);
            }

            await updateDoc(doc(db, "apontamentos", orcId), {
                historico_trabalhos: historico,
                status: item.status, 
                updated_at: serverTimestamp()
            });

            limparFormApontamentoItem();
            // Mant√©m modal aberto e recarrega lista (via snapshot listener que chamar√° render)
            // Mas fechamos o modal se for edi√ß√£o para evitar confus√£o ou resetamos para novo?
            // Melhor resetar para novo.
            document.getElementById('apt-index-editing').value = "-1";
            alert("Apontamento registrado!");
        };

        window.limparFormApontamentoItem = () => {
            document.getElementById('form-apontamento-item').reset();
            document.getElementById('apt-reg-inicio').value = "";
            document.getElementById('apt-reg-inicio').removeAttribute('data-real-value');
            document.getElementById('apt-reg-fim').value = "";
            document.getElementById('apt-reg-fim').removeAttribute('data-real-value');
            document.getElementById('apt-index-editing').value = "-1";
        };

        window.renderHistoricoApontamentosNoModal = () => {
            const div = document.getElementById('lista-historico-apontamentos');
            div.innerHTML = '';
            
            if(!orcamentoAtual.historico_trabalhos || orcamentoAtual.historico_trabalhos.length === 0) {
                div.innerHTML = '<p style="color:#888; text-align:center;">Nenhum apontamento ainda.</p>';
                return;
            }

            const listaInvertida = [...orcamentoAtual.historico_trabalhos].reverse();

            listaInvertida.forEach((h, idx) => {
                const seq = orcamentoAtual.historico_trabalhos.length - idx;
                div.innerHTML += `
                    <div class="hist-list-item">
                        <strong>#${seq} - ${h.atendente}</strong> <span class="stage-tag">${h.status}</span><br>
                        In√≠cio: ${formatBR(h.inicio)} <small style="color:#666">(Reg: ${h.reg_inicio || '-'})</small><br>
                        Fim: ${formatBR(h.fim)} <small style="color:#666">(Reg: ${h.reg_fim || '-'})</small><br>
                        <em>${h.obs || ''}</em>
                    </div>
                `;
            });
        };

        // --- RESTANTE DAS FUN√á√ïES ORIGINAIS (Mantidas) ---

        window.handleFileUpload = async (files) => {
            if(!leadAtual) return alert("Salve os dados b√°sicos antes de enviar arquivos.");
            const file = files[0]; if(!file) return;
            const path = `leads/${leadAtual.id}/${Date.now()}_${file.name}`;
            const storageRef = ref(storage, path);
            try {
                const snapshot = await uploadBytes(storageRef, file);
                const url = await getDownloadURL(snapshot.ref);
                const arquivos = leadAtual.arquivos || [];
                arquivos.push({ name: file.name, url: url, path: path });
                await updateDoc(doc(db, "leads", leadAtual.id), { arquivos: arquivos });
                alert("Arquivo enviado!");
            } catch (err) { console.error(err); alert("Erro ao enviar arquivo."); }
            document.getElementById('lead-file-input').value = "";
        };

        window.renderArquivos = () => {
            const list = document.getElementById('lead-files-list'); list.innerHTML = "";
            if(!leadAtual || !leadAtual.arquivos) return;
            leadAtual.arquivos.forEach((file, idx) => {
                list.innerHTML += `<div class="file-item"><a href="${file.url}" target="_blank" class="file-name">${file.name}</a><button class="btn-icon" onclick="excluirArquivo(${idx})" style="color:red">üóëÔ∏è</button></div>`;
            });
        };

        window.excluirArquivo = async (idx) => {
            if(!confirm("Excluir este arquivo permanentemente?")) return;
            const file = leadAtual.arquivos[idx]; const storageRef = ref(storage, file.path);
            try { await deleteObject(storageRef); const arquivos = [...leadAtual.arquivos]; arquivos.splice(idx, 1); await updateDoc(doc(db, "leads", leadAtual.id), { arquivos: arquivos }); } 
            catch (err) { console.error(err); alert("Erro ao excluir arquivo."); }
        };

        window.handleHistContato = (val) => {
            const areaOutra = document.getElementById('area-contato-outra');
            areaOutra.style.display = (val === 'Outra') ? 'block' : 'none';
            let targetId = "";
            if(val === 'Propriet√°rio') targetId = leadAtual.cliente_id;
            else if(val === 'Arquiteto') targetId = leadAtual.arquiteto_id;
            else if(val === 'Respons√°vel Obra') targetId = leadAtual.responsavel_id;
            else if(val === 'Adm Obra') targetId = leadAtual.adm_obra_id;
            else if(val === 'Construtora') targetId = leadAtual.construtora_id;
            if(val !== 'Outra') updateHistContactDisplay(targetId);
        };

        window.updateHistContactDisplay = (id) => {
            const span = document.getElementById('info-hist-contato');
            const item = listaClientes.find(c => c.id === id);
            span.innerHTML = item ? `${item.nome_empresa}<br>üìû ${item.telefone || '-'} | üìß ${item.email || '-'}` : "Contato n√£o vinculado nos dados b√°sicos.";
        };

        window.renderFunnel = () => {
            const cols = {novo:'list-novo', contatado:'list-contatado', orcamento:'list-orcamento', negociacao:'list-negociacao', fechado:'list-fechado', perdido:'list-perdido'};
            Object.values(cols).forEach(id => document.getElementById(id).innerHTML = '');
            const atend = document.getElementById('f-funil-atend').value;
            const dtIni = document.getElementById('f-funil-ini').value, dtFim = document.getElementById('f-funil-fim').value, fReal = document.getElementById('f-funil-real').value;
            const showAll = document.getElementById('f-funil-all').checked;

            listaLeads.forEach(lead => {
                const hist = lead.historico || [];
                const itemsToProcess = (hist.length > 0) ? (showAll ? hist : [hist[hist.length-1]]) : [{etapa: lead.etapa || 'novo', temperatura: ""}];
                itemsToProcess.forEach(h => {
                    if(atend !== 'todos' && h.atendente !== atend) return;
                    if(h.temperatura && !starFilters.includes(parseInt(h.temperatura))) return;
                    if(fReal === 'com' && !h.data_realizada) return;
                    if(fReal === 'sem' && h.data_realizada) return;
                    if(dtIni || dtFim) { if(!h.data_programada) return; const pDate = h.data_programada.split('T')[0]; if(dtIni && pDate < dtIni) return; if(dtFim && pDate > dtFim) return; }
                    const desde = lead.created_at ? new Date(lead.created_at.toDate()).toLocaleString('pt-BR') : '-';
                    let cor = '';
                    if(h.data_programada && !h.data_realizada) { cor = new Date(h.data_programada) < new Date() ? 'card-red' : 'card-blue'; } else if(h.data_realizada) cor = 'card-green';
                    const div = document.getElementById(cols[h.etapa]);
                    if(div) {
                        div.innerHTML += `<div class="card ${cor}" onclick="editarLead('${lead.id}')"><span class="card-number">${lead.numero_lead||''}</span><span class="card-stars">${h.temperatura ? "‚≠ê".repeat(h.temperatura) : ""}</span><span class="card-title">${lead.nome_cliente_cache}</span><div class="card-dates"><b>Tipo:</b> ${h.contato_tipo || 'N/A'}<br><b>Desde:</b> ${desde}<br><b>Prog:</b> ${formatBR(h.data_programada)}<br><b>Real:</b> ${formatBR(h.data_realizada)}</div></div>`;
                    }
                });
            });
            Object.keys(cols).forEach(key => { const count = document.getElementById(cols[key]).children.length; const badge = document.getElementById('c-' + key); if(badge) badge.innerText = count; });
        };

        window.renderTableLeads = () => {
            const tb = document.querySelector('#table-leads tbody'); tb.innerHTML = '';
            listaLeads.forEach(l => {
                const etapa = (l.historico && l.historico.length) ? l.historico[l.historico.length-1].etapa : 'novo';
                const desde = l.created_at ? new Date(l.created_at.toDate()).toLocaleString('pt-BR', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'}) : '-';
                const cliente = listaClientes.find(c => c.id === l.cliente_id);
                const tel = (cliente && cliente.telefone) ? cliente.telefone.replace(/\D/g, '') : '';
                const btnWhats = tel ? `<a href="https://wa.me/55${tel}" target="_blank" style="text-decoration:none; margin-right:8px; font-size:1.1em;">üü¢</a>` : '';
                tb.innerHTML += `<tr onclick="editarLead('${l.id}')"><td>${l.numero_lead||''}</td><td>${desde}</td><td>${l.nome_cliente_cache}</td><td style="text-transform:capitalize">${etapa}</td><td>${btnWhats}<button class="btn-icon" onclick="event.stopPropagation(); editarLead('${l.id}')">‚úèÔ∏è</button> <button class="btn-icon" onclick="event.stopPropagation(); excluirLead('${l.id}')" style="color:red">üóëÔ∏è</button></td></tr>`;
            });
        };

        window.processarDashboard = () => {
            const iniStr = document.getElementById('dash-inicio').value; const fimStr = document.getElementById('dash-fim').value;
            if(!iniStr || !fimStr) return;
            const ini = new Date(iniStr + "T00:00:00"), fim = new Date(fimStr + "T23:59:59"), atendente = document.getElementById('dash-atendente').value;
            const origemCount = {}, leadsDiaCount = {}, stageDurations = {}, cycleTimes = {contatado:[], orcamento:[], negociacao:[], fechado:[]};
            let countPrazo=0, countAtraso=0, filteredData=[], totalDelayHours = 0;

            listaLeads.forEach(l => {
                const dtCriacao = l.created_at ? l.created_at.toDate() : null;
                if(dtCriacao && dtCriacao >= ini && dtCriacao <= fim) {
                    origemCount[l.origem] = (origemCount[l.origem]||0)+1;
                    const keyDay = dtCriacao.toLocaleDateString('pt-BR');
                    leadsDiaCount[keyDay] = (leadsDiaCount[keyDay]||0)+1;
                }
                if(l.historico) {
                    let lastDate = dtCriacao;
                    l.historico.forEach((h, idx) => {
                        const dataRef = h.data_realizada ? new Date(h.data_realizada) : (h.data_programada ? new Date(h.data_programada) : null);
                        if(dataRef) {
                            if(lastDate) { const diffDias = (dataRef - lastDate) / (1000*60*60*24); const prevEtapa = idx === 0 ? 'novo' : l.historico[idx-1].etapa; if(!stageDurations[prevEtapa]) stageDurations[prevEtapa] = []; stageDurations[prevEtapa].push(diffDias); }
                            if(dtCriacao && cycleTimes[h.etapa] !== undefined) cycleTimes[h.etapa].push((dataRef - dtCriacao) / (1000*60*60*24));
                            lastDate = dataRef;
                            if(atendente === 'todos' || h.atendente === atendente) {
                                if(dataRef >= ini && dataRef <= fim) {
                                    let isDelayed = false;
                                    if(h.data_programada && h.data_realizada) { const p = new Date(h.data_programada), r = new Date(h.data_realizada); if(r > p) { isDelayed = true; totalDelayHours += (r - p) / (1000*60*60); } }
                                    else if (h.data_programada && !h.data_realizada && new Date(h.data_programada) < new Date()) { isDelayed = true; totalDelayHours += (new Date() - new Date(h.data_programada)) / (1000*60*60); }
                                    if(isDelayed) countAtraso++; else countPrazo++;
                                    filteredData.push({id: l.id, dt: dataRef.toLocaleString('pt-BR'), etapa: h.etapa, num: l.numero_lead, cli: l.nome_cliente_cache, st: isDelayed ? 'Atrasado' : 'No Prazo'});
                                }
                            }
                        }
                    });
                }
            });
            const badge = document.getElementById('delay-metric');
            if(countAtraso > 0) { const avgDelay = totalDelayHours / countAtraso; const d = Math.floor(avgDelay/24), h = Math.floor(avgDelay % 24); badge.innerText = `‚è≥ Atraso M√©dio: ${d}d ${h}h`; badge.style.display = 'block'; } else badge.style.display = 'none';
            const stageMeans = Object.keys(stageDurations).map(k => ({etapa: k, media: (stageDurations[k].reduce((a,b)=>a+b,0) / stageDurations[k].length).toFixed(1)}));
            const cycleMeans = Object.keys(cycleTimes).map(k => cycleTimes[k].length ? (cycleTimes[k].reduce((a,b)=>a+b,0) / cycleTimes[k].length).toFixed(1) : 0);
            drawCharts(origemCount, leadsDiaCount, countPrazo, countAtraso, stageMeans, cycleMeans);
            renderDashTable(filteredData);
        };

        function drawCharts(origem, leadsDia, prazo, atraso, stageMeans, cycleMeans) {
            if(chartOrigem) chartOrigem.destroy(); chartOrigem = new Chart(document.getElementById('chartOrigem'), { type: 'bar', data: { labels: Object.keys(origem), datasets: [{ label: 'Leads', data: Object.values(origem), backgroundColor: '#007bff' }] }, options: { indexAxis: 'y', maintainAspectRatio: false } });
            if(chartLeadsDay) chartLeadsDay.destroy(); const keys = Object.keys(leadsDia).sort((a,b) => { const [d1,m1,y1]=a.split('/'); const [d2,m2,y2]=b.split('/'); return new Date(`${y1}-${m1}-${d1}`) - new Date(`${y2}-${m2}-${d2}`); }); chartLeadsDay = new Chart(document.getElementById('chartLeadsDay'), { type: 'bar', data: { labels: keys, datasets: [{ label: 'Novos Leads', data: keys.map(k=>leadsDia[k]), backgroundColor: '#28a745' }] }, options: { maintainAspectRatio: false } });
            if(chartPerf) chartPerf.destroy(); chartPerf = new Chart(document.getElementById('chartPerformance'), { type: 'doughnut', data: { labels: ['No Prazo', 'Atrasado'], datasets: [{ data: [prazo, atraso], backgroundColor: ['#28a745', '#dc3545'] }] }, options: { maintainAspectRatio: false } });
            if(chartStageTime) chartStageTime.destroy(); chartStageTime = new Chart(document.getElementById('chartStageTime'), { type: 'bar', data: { labels: stageMeans.map(m=>m.etapa), datasets: [{ label: 'Dias M√©dios', data: stageMeans.map(m=>m.media), backgroundColor: '#fd7e14' }] }, options: { maintainAspectRatio: false } });
            if(chartCycleTime) chartCycleTime.destroy(); chartCycleTime = new Chart(document.getElementById('chartCycleTime'), { type: 'line', data: { labels: ['Contato', 'Or√ßamento', 'Negocia√ß√£o', 'Fechado'], datasets: [{ label: 'Dias desde a cria√ß√£o', data: cycleMeans, borderColor: '#007bff', tension: 0.3, fill: true, backgroundColor: 'rgba(0,123,255,0.1)' }] }, options: { maintainAspectRatio: false } });
        }

        function renderDashTable(data) { const tb = document.querySelector('#dash-table tbody'); tb.innerHTML = ''; document.getElementById('dash-count').innerText = `(${data.length} registros)`; data.forEach(r => tb.innerHTML += `<tr onclick="editarLead('${r.id}')"><td>${r.dt}</td><td>${r.etapa}</td><td>${r.num}</td><td>${r.cli}</td><td>${r.st}</td></tr>`); }

        document.getElementById('form-historico').onsubmit = async(e) => {
            e.preventDefault();
            const idx = document.getElementById('hist-index').value;
            const h = { 
                atendente: document.getElementById('hist-atendente').value,
                contato_tipo: document.getElementById('hist-contato-tipo').value,
                contato_id: (document.getElementById('hist-contato-tipo').value === 'Outra') ? document.getElementById('hist-contato-id').value : "",
                etapa: document.getElementById('hist-etapa').value,
                data_programada: document.getElementById('hist-prog').value,
                data_realizada: document.getElementById('hist-real').value,
                resultado: document.getElementById('hist-resultado').value,
                resumo: document.getElementById('hist-resumo').value,
                temperatura: document.getElementById('hist-temp').value,
                data_operacao: new Date().toLocaleString('pt-BR')
            };
            if (h.etapa !== 'novo' && !h.temperatura) { alert("A classifica√ß√£o por estrelas √© obrigat√≥ria para esta etapa."); return; }
            if (h.data_realizada && !h.resultado) { alert("O campo 'Resultado da Intera√ß√£o' √© obrigat√≥rio quando a data 'Realizado' √© preenchida."); return; }
            
            let hist = [...(leadAtual.historico || [])];
            if(idx !== "") { h.updated_realizada_at = (hist[parseInt(idx)].data_realizada !== h.data_realizada) ? new Date().toLocaleString('pt-BR') : (hist[parseInt(idx)].updated_realizada_at || '-'); hist[parseInt(idx)] = h; } 
            else {
                h.updated_realizada_at = h.data_realizada ? new Date().toLocaleString('pt-BR') : '-'; hist.push(h);
                if (h.data_realizada && h.resultado === "Insucesso") { hist.push({ ...h, data_realizada: "", resultado: "", data_operacao: new Date().toLocaleString('pt-BR'), updated_realizada_at: '-', resumo: "REAGENDAMENTO AUTOM√ÅTICO (Insucesso): " + h.resumo }); }
            }
            await updateDoc(doc(db, "leads", leadAtual.id), { historico: hist, etapa: h.etapa });
            leadAtual.historico = hist; renderTimeline(); limparFormHist();
        };

        window.editHist = (i) => {
            const h = leadAtual.historico[i];
            document.getElementById('hist-index').value = i;
            document.getElementById('hist-atendente').value = h.atendente;
            document.getElementById('hist-contato-tipo').value = h.contato_tipo || "";
            handleHistContato(h.contato_tipo);
            if(h.contato_tipo === 'Outra') document.getElementById('hist-contato-id').value = h.contato_id || "";
            document.getElementById('hist-etapa').value = h.etapa;
            document.getElementById('hist-temp').value = h.temperatura || "";
            document.getElementById('hist-prog').value = h.data_programada || '';
            document.getElementById('hist-real').value = h.data_realizada || '';
            document.getElementById('hist-resultado').value = h.resultado || '';
            document.getElementById('hist-resumo').value = h.resumo;
            document.getElementById('hist-upd-real').value = h.updated_realizada_at || '-';
            document.getElementById('btn-save-hist').innerText = "Atualizar Intera√ß√£o";
        };

        window.novoHistBaseado = (i) => {
            const h = leadAtual.historico[i]; limparFormHist();
            document.getElementById('hist-atendente').value = h.atendente;
            document.getElementById('hist-contato-tipo').value = h.contato_tipo || ""; handleHistContato(h.contato_tipo);
            document.getElementById('hist-etapa').value = h.etapa; document.getElementById('hist-temp').value = h.temperatura || "";
            document.getElementById('btn-save-hist').innerText = "+ Gravar Intera√ß√£o"; document.getElementById('form-historico').scrollIntoView();
        };

        window.switchView = (v) => { document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active')); document.getElementById('view-' + v).classList.add('active'); document.querySelectorAll('.nav-buttons button').forEach(b => b.classList.remove('active')); if(document.getElementById('btn-'+v)) document.getElementById('btn-'+v).classList.add('active'); if(v==='dashboard') processarDashboard(); };
        window.toggleStarFilter = (s) => { const i = starFilters.indexOf(s); if(i>-1) starFilters.splice(i,1); else starFilters.push(s); renderFunnel(); };
        window.limparFormLead = () => { document.getElementById('form-lead-main').reset(); document.getElementById('lead-id').value=''; document.getElementById('area-historico').style.display='none'; document.getElementById('area-arquivos').style.display='none'; leadAtual=null; document.querySelectorAll('.contact-info-display').forEach(s => s.innerText = ""); };
        window.limparFormHist = () => { document.getElementById('form-historico').reset(); document.getElementById('hist-index').value=''; document.getElementById('btn-save-hist').innerText = "+ Gravar Intera√ß√£o"; document.getElementById('info-hist-contato').innerText = ""; document.getElementById('area-contato-outra').style.display = "none"; };
        window.excluirLead = async(id) => { if(confirm("Excluir Lead?")) await deleteDoc(doc(db,"leads",id)); };
        window.novoLeadDireto = () => { window.switchView('leads'); window.limparFormLead(); };
        window.excluirCli = async(id) => { if(listaLeads.some(l => l.cliente_id === id)) return alert("Erro: Este registro possui leads."); if(confirm("Excluir Registro?")) await deleteDoc(doc(db, "clientes", id)); };
        window.excluirAtend = async(id) => { const nome = listaAtendentes.find(a => a.id === id)?.nome; if(listaLeads.some(l => (l.historico || []).some(h => h.atendente === name))) return alert("Erro: Atendente possui intera√ß√µes."); if(confirm("Excluir Atendente?")) await deleteDoc(doc(db, "atendentes", id)); };
        
        document.getElementById('form-cliente').onsubmit = async(e) => { 
            e.preventDefault(); const id=document.getElementById('cli-id').value, d={ nome_empresa:document.getElementById('cli-nome').value, tipo:document.getElementById('cli-tipo').value, status:document.getElementById('cli-status').value, telefone:document.getElementById('cli-telefone').value, email:document.getElementById('cli-email').value, cidade:document.getElementById('cli-cidade').value, endereco:document.getElementById('cli-endereco').value }; 
            if(id) await updateDoc(doc(db,"clientes",id),d); else await addDoc(collection(db,"clientes"),d); document.getElementById('form-cliente').reset(); document.getElementById('cli-id').value=''; 
        };
        
        document.getElementById('form-atendente').onsubmit = async(e) => { e.preventDefault(); const id=document.getElementById('atend-id').value, d={ nome:document.getElementById('atend-nome').value, email:document.getElementById('atend-email').value, whats:document.getElementById('atend-whats').value }; if(id) await updateDoc(doc(db,"atendentes",id),d); else await addDoc(collection(db,"atendentes"),d); document.getElementById('form-atendente').reset(); document.getElementById('atend-id').value=''; };
        
        document.getElementById('form-lead-main').onsubmit = async(e) => { 
            e.preventDefault(); const id=document.getElementById('lead-id').value, sel=document.getElementById('lead-cliente'), origem = document.getElementById('lead-origem').value, indicacao = document.getElementById('lead-indicacao').value;
            if(origem.toUpperCase().includes("INDICA√á√ÉO") && !indicacao) { alert("O campo Indica√ß√£o √© obrigat√≥rio para esta origem."); return; }
            const d={ cliente_id:sel.value, nome_cliente_cache:sel.options[sel.selectedIndex].text, origem:origem, indicacao_id: indicacao, pvc_metragem: document.getElementById('lead-pvc-metragem').value, pvc_pecas: document.getElementById('lead-pvc-pecas').value, pvc_margem_padrao: document.getElementById('lead-pvc-margem-padrao').value, pvc_margem_especial: document.getElementById('lead-pvc-margem-especial').value, pvc_valor_orcamento: document.getElementById('lead-pvc-valor-orcamento').value, pvc_valor_pedido: document.getElementById('lead-pvc-valor-pedido').value, alu_metragem: document.getElementById('lead-alu-metragem').value, alu_pecas: document.getElementById('lead-alu-pecas').value, alu_margem_padrao: document.getElementById('lead-alu-margem-padrao').value, alu_margem_especial: document.getElementById('lead-alu-margem-especial').value, alu_valor_orcamento: document.getElementById('lead-alu-valor-orcamento').value, alu_valor_pedido: document.getElementById('lead-alu-valor-pedido').value, previsao:document.getElementById('lead-previsao').value, construtora_id: document.getElementById('lead-construtora').value, adm_obra_id: document.getElementById('lead-adm-obra').value, arquiteto_id: document.getElementById('lead-arquiteto').value, responsavel_id: document.getElementById('lead-responsavel').value, updated_at:serverTimestamp() }; 
            if(id) await updateDoc(doc(db,"leads",id),d); else { d.created_at=serverTimestamp(); d.numero_lead="#L-"+Math.floor(1000+Math.random()*9000); d.etapa='novo'; await addDoc(collection(db,"leads"),d); } 
            alert('Dados Salvos!'); 
        };

        window.editarLead = (id) => { 
            leadAtual = listaLeads.find(l => l.id === id); switchView('leads'); document.getElementById('lead-id').value = id; 
            document.getElementById('lead-cliente').value = leadAtual.cliente_id; showInfo('cliente', leadAtual.cliente_id);
            document.getElementById('lead-origem').value = leadAtual.origem; document.getElementById('lead-indicacao').value = leadAtual.indicacao_id || ''; showInfo('indicacao', leadAtual.indicacao_id);
            document.getElementById('lead-pvc-metragem').value = leadAtual.pvc_metragem || ''; document.getElementById('lead-pvc-pecas').value = leadAtual.pvc_pecas || ''; document.getElementById('lead-pvc-margem-padrao').value = leadAtual.pvc_margem_padrao || ''; document.getElementById('lead-pvc-margem-especial').value = leadAtual.pvc_margem_especial || ''; document.getElementById('lead-pvc-valor-orcamento').value = leadAtual.pvc_valor_orcamento || ''; document.getElementById('lead-pvc-valor-pedido').value = leadAtual.pvc_valor_pedido || '';
            document.getElementById('lead-alu-metragem').value = leadAtual.alu_metragem || ''; document.getElementById('lead-alu-pecas').value = leadAtual.alu_pecas || ''; document.getElementById('lead-alu-margem-padrao').value = leadAtual.alu_margem_padrao || ''; document.getElementById('lead-alu-margem-especial').value = leadAtual.alu_margem_especial || ''; document.getElementById('lead-alu-valor-orcamento').value = leadAtual.alu_valor_orcamento || ''; document.getElementById('lead-alu-valor-pedido').value = leadAtual.alu_valor_pedido || '';
            document.getElementById('lead-previsao').value = leadAtual.previsao || ''; document.getElementById('lead-construtora').value = leadAtual.construtora_id || ''; showInfo('construtora', leadAtual.construtora_id); document.getElementById('lead-adm-obra').value = leadAtual.adm_obra_id || ''; showInfo('adm-obra', leadAtual.adm_obra_id); document.getElementById('lead-arquiteto').value = leadAtual.arquiteto_id || ''; showInfo('arquiteto', leadAtual.arquiteto_id); document.getElementById('lead-responsavel').value = leadAtual.responsavel_id || ''; showInfo('responsavel', leadAtual.responsavel_id);
            document.getElementById('area-historico').style.display = 'block'; document.getElementById('area-arquivos').style.display = 'block'; limparFormHist(); renderTimeline(); renderArquivos();
        };

        window.editarCli = (id) => { const c = listaClientes.find(x => x.id === id); switchView('cadastro'); document.getElementById('cli-id').value = c.id; document.getElementById('cli-nome').value = c.nome_empresa; document.getElementById('cli-tipo').value = c.tipo || 'Cliente'; document.getElementById('cli-status').value = c.status; document.getElementById('cli-telefone').value = c.telefone || ''; document.getElementById('cli-email').value = c.email || ''; document.getElementById('cli-cidade').value = c.cidade || ''; document.getElementById('cli-endereco').value = c.endereco || ''; };
        window.editarAtend = (id) => { const a = listaAtendentes.find(x => x.id === id); switchView('atendentes'); document.getElementById('atend-id').value = a.id; document.getElementById('atend-nome').value = a.nome; document.getElementById('atend-email').value = a.email; document.getElementById('atend-whats').value = a.whats || ''; };
        
        window.renderTimeline = () => { 
            const div = document.getElementById('timeline-list'); div.innerHTML = ''; const histArray = (leadAtual.historico || []).map((h, i) => ({...h, idx: i}));
            histArray.reverse().forEach((h, indexInTimeline) => { 
                const btnNovo = (indexInTimeline === 0) ? `<button class="btn-icon" onclick="novoHistBaseado(${h.idx})" title="Novo baseado neste">‚ûï</button>` : '';
                let targetId = (h.contato_tipo === 'Propriet√°rio') ? leadAtual.cliente_id : (h.contato_tipo === 'Arquiteto') ? leadAtual.arquiteto_id : (h.contato_tipo === 'Respons√°vel Obra') ? leadAtual.responsavel_id : (h.contato_tipo === 'Adm Obra') ? leadAtual.adm_obra_id : (h.contato_tipo === 'Construtora') ? leadAtual.construtora_id : h.contato_id;
                const contactData = listaClientes.find(c => c.id === targetId); const phone = contactData ? contactData.telefone.replace(/\D/g, '') : ''; const btnWhats = phone ? `<a href="https://wa.me/55${phone}" target="_blank" style="text-decoration:none; margin-left:10px; font-size:1.1em;">üü¢</a>` : '';
                
                div.innerHTML += `<div class="timeline-item">
                    <div class="seq-badge">${h.idx + 1}</div>
                    <div class="tl-header">
                        <span class="stage-tag">${h.etapa}</span>
                        <div><button class="btn-icon" onclick="editHist(${h.idx})">‚úèÔ∏è</button>${btnNovo}<button class="btn-del-hist" onclick="delHist(${h.idx})">üóëÔ∏è</button></div>
                    </div>
                    <span style="font-size:0.8em; color:var(--primary); font-weight:bold;">üë§ ${h.atendente}</span><br>
                    <span style="font-size:0.75em; color:#666">üìû Contato: ${h.contato_tipo || 'N/A'} ${btnWhats} | üìÖ Opera√ß√£o: ${h.data_operacao || '-'} | üèÅ Status: ${h.resultado || '-'}</span>
                    <div onclick="editHist(${h.idx})" style="cursor:pointer; margin-top:5px;">
                        <b>Prog:</b> ${formatBR(h.data_programada)} | <b>Real:</b> ${formatBR(h.data_realizada)} <span style="color:#ffc107">${h.temperatura ? "‚≠ê".repeat(h.temperatura) : ""}</span><br>
                        <i>${h.resumo}</i>
                    </div>
                </div>`; 
            }); 
        };

        window.delHist = async (i) => { if(!confirm("Excluir esta intera√ß√£o?")) return; let hist = [...leadAtual.historico]; hist.splice(i, 1); const ultEtapa = hist.length ? hist[hist.length-1].etapa : 'novo'; await updateDoc(doc(db, "leads", leadAtual.id), { historico: hist, etapa: ultEtapa }); leadAtual.historico = hist; renderTimeline(); };
        window.onload = () => { const h = new Date(); document.getElementById('dash-inicio').value = new Date(h.getFullYear(), h.getMonth(), 1).toISOString().split('T')[0]; document.getElementById('dash-fim').value = h.toISOString().split('T')[0]; applyMasks(); };
    </script>
</body>
</html>
