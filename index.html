<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfecta CRM - V16.1 (Auth & Permiss√µes)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #007bff; --bg: #e9eef2; --text: #333;
            --success: #28a745; --danger: #dc3545; --warning: #ffc107; --info: #17a2b8;
            --purple: #6f42c1; --teal: #20c997; --orange: #fd7e14;
        }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: var(--bg); display: flex; flex-direction: column; height: 100vh; }
        
        nav { background: white; padding: 0 20px; height: 60px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-shrink: 0; z-index: 100; }
        .brand { font-weight: bold; font-size: 1.2rem; color: var(--primary); }
        .nav-buttons { display: flex; flex: 1; margin-left: 20px; }
        .nav-buttons button { background: transparent; border: none; padding: 10px 15px; cursor: pointer; border-bottom: 3px solid transparent; color: #666; font-size: 0.95rem; transition: 0.3s; }
        .nav-buttons button:hover { background-color: #f8f9fa; }
        .nav-buttons button.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: bold; }

        .view-section { display: none; flex: 1; overflow: hidden; padding: 20px; }
        .view-section.active { display: flex; flex-direction: column; }
        .management-container { display: flex; gap: 20px; height: 100%; }
        
        .form-area { width: 650px; background: white; padding: 20px; border-radius: 8px; overflow-y: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .list-area { flex: 1; background: white; padding: 20px; border-radius: 8px; display: flex; flex-direction: column; }

        label { font-weight: 600; font-size: 0.85em; display: block; margin-bottom: 4px; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        .contact-info-display { font-size: 0.75em; color: #007bff; margin-top: -10px; margin-bottom: 10px; display: block; min-height: 1em; }

        .obra-section { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee; }
        .pvc-bg { background-color: #f0f7ff; border-left: 5px solid #007bff; }
        .alu-bg { background-color: #fff4e5; border-left: 5px solid #fd7e14; }
        .obra-title { grid-column: span 2; font-weight: bold; font-size: 0.9em; margin-bottom: 5px; color: #444; text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 5px; }

        .funnel-filters { background: white; padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; display: flex; gap: 15px; flex-wrap: wrap; font-size: 0.85em; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .funnel-filters label { margin: 0; display: flex; align-items: center; gap: 4px; font-weight: normal; }
        
        .board { display: flex; overflow-x: auto; gap: 10px; height: 100%; align-items: flex-start; }
        .column { background: #f0f2f5; min-width: 210px; width: 210px; border-radius: 8px; display: flex; flex-direction: column; max-height: 100%; }
        .column-header { padding: 10px; font-weight: bold; color: white; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; font-size: 0.9em; }
        .column-body { padding: 8px; flex: 1; overflow-y: auto; }
        
        .col-novo { background: #6c757d; } .col-contatado { background: #17a2b8; } 
        .col-orcamento { background: #ffc107; color:#333 !important; } .col-negociacao { background: #fd7e14; }
        .col-fechado { background: #28a745; } .col-perdido { background: #dc3545; }

        .card { background: white; border-radius: 6px; padding: 10px; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; border-left: 5px solid #ccc; position: relative; }
        .card-blue { background-color: #e3f2fd !important; border-left-color: #2196f3 !important; }
        .card-red { background-color: #ffebee !important; border-left-color: #f44336 !important; }
        .card-yellow { background-color: #fffde7 !important; border-left-color: #fbc02d !important; }
        .card-green { background-color: #e8f5e9 !important; border-left-color: #4caf50 !important; }
        .card-number { display: none; }
        .card-stars { font-size: 0.8em; margin-bottom: 2px; display: block; color: #ffc107; }
        .card-title { font-weight: bold; display: block; margin-bottom: 4px; margin-right: 30px; font-size: 0.92em; }
        .card-dates { font-size: 0.7em; color: #555; background: rgba(255,255,255,0.6); padding: 4px; border-radius: 4px; line-height: 1.3; }

        .timeline-item { border-left: 3px solid #ddd; padding: 8px 15px; margin-bottom: 10px; border-radius: 0 6px 6px 0; background: #fafafa; position: relative; }
        .seq-badge { position: absolute; left: -12px; top: 0; background: #666; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7em; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .tl-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .stage-tag { background: #333; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7em; text-transform: uppercase; }
        .btn-del-hist { background: none; border: none; cursor: pointer; font-size: 1.1em; color: #dc3545; }
        
        .orc-integration-box { margin-top: 8px; background: #eef6fc; border: 1px solid #d1e7fa; border-radius: 4px; padding: 6px; font-size: 0.8em; color: #0056b3; cursor: pointer; }
        .orc-integration-box:hover { background: #dceefc; }

        .file-item { display: flex; align-items: center; justify-content: space-between; background: #f8f9fa; padding: 8px; border-radius: 4px; margin-bottom: 5px; border: 1px solid #eee; font-size: 0.85em; }
        .file-name { color: var(--primary); text-decoration: none; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 80%; }
        .file-name:hover { text-decoration: underline; }

        .dashboard-grid { overflow-y: auto; padding-bottom: 20px; height: 100%; display: flex; flex-direction: column; }
        .filter-bar { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; flex-shrink: 0; }
        .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; flex-shrink: 0; margin-bottom: 15px; }
        .chart-box { background: white; padding: 10px; border-radius: 8px; height: 220px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; }
        .chart-box-wide { grid-column: span 2; height: 300px; }
        .chart-title { font-weight: bold; font-size: 0.85em; margin-bottom: 5px; color: #555; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .metric-badge { position: absolute; top: 35px; right: 15px; background: #ffebee; color: #d32f2f; padding: 4px 8px; border-radius: 4px; font-size: 0.75em; font-weight: bold; }

        .btn-save { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-icon { border: none; background: #eee; padding: 5px 8px; border-radius: 4px; cursor: pointer; font-size: 1.1em; }
        .table-wrapper { flex: 1; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background: #f1f3f5; text-align: left; padding: 10px; position: sticky; top: 0; border-bottom: 2px solid #ddd; color: #444; }
        td { padding: 8px 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover { background-color: #f8f9fa; cursor: pointer; }

        #dialog-apontamento { border: none; border-radius: 8px; padding: 20px; width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        #dialog-apontamento::backdrop { background: rgba(0,0,0,0.5); }
        .readonly-field { background-color: #e9ecef; color: #6c757d; cursor: not-allowed; }
        .hist-list-item { font-size: 0.8em; padding: 8px; border-bottom: 1px solid #eee; background: #fafafa; margin-bottom: 4px; }
        
        .btn-group-row { display: flex; gap: 8px; justify-content: center; align-items: center; white-space: nowrap; }
        .status-badge-funnel { display:inline-block; margin-top:3px; padding: 2px 5px; border-radius: 3px; font-size: 0.75em; background: #eee; border: 1px solid #ddd; color: #555; font-weight: 500; }
        
        .filter-panel { background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #eee; margin-bottom: 15px; font-size: 0.85em; }
        .filter-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; }
        .filter-item { flex: 1; min-width: 150px; }
        .filter-check-group { display: flex; gap: 15px; padding: 5px 0; }

        .hist-mini-card { background: #fdfdfd; border: 1px solid #eee; border-left: 3px solid var(--info); padding: 6px 12px; margin-top: 5px; border-radius: 4px; font-size: 0.85em; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; }
        .hist-mini-card:hover { background: #f0f7ff; }
        .actions-cell { display: flex; align-items: center; justify-content: center; gap: 8px; height: 100%; }

        /* Estilos Extras - Permiss√µes & Login */
        #login-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .perm-group { background: #fafafa; border: 1px solid #eee; border-radius: 6px; padding: 12px; margin-bottom: 10px; }
        .perm-group h4 { margin: 0 0 10px 0; font-size: 0.9em; color: #444; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .perm-row { display: flex; gap: 15px; font-size: 0.85em; }
        .perm-row label { display: flex; align-items: center; gap: 5px; margin: 0; font-weight: normal; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="form-area" style="width: 350px;">
            <h2 style="text-align:center; color:var(--primary); margin-top: 0;">Perfecta CRM Access</h2>
            <form id="form-login">
                <label>E-mail</label>
                <input type="email" id="log-email" required>
                <label>Senha</label>
                <input type="password" id="log-pass" required minlength="6">
                <button type="submit" class="btn-save" id="btn-login-submit">Entrar</button>
                <div style="text-align:center; margin-top:15px; font-size:0.85em;">
                    <a href="#" id="toggle-login-mode" style="color:var(--primary); text-decoration:none;">N√£o tem conta? Cadastrar-se</a>
                </div>
            </form>
        </div>
    </div>

    <nav id="main-nav" style="display: none;">
        <div class="brand">Perfecta CRM v16.1</div>
        <div class="nav-buttons">
            <button onclick="switchView('funil')" id="btn-funil" class="active">üìä Funil</button>
            <button onclick="switchView('orcamentos')" id="btn-orcamentos">üïê Or√ßamentos</button>
            <button onclick="switchView('leads')" id="btn-leads">üéØ Leads</button>
            <button onclick="switchView('cadastro')" id="btn-cadastro">üë• Cadastro</button>
            <button onclick="switchView('atendentes')" id="btn-atendentes">üíº Atendentes</button>
            <button onclick="switchView('dashboard')" id="btn-dashboard">üìà Dashboard</button>
            <button onclick="switchView('usuarios')" id="btn-usuarios" style="color:#ffc107; font-weight:bold;">üîí Usu√°rios</button>
        </div>
        <div style="display:flex; align-items:center; gap: 15px;">
            <span id="user-info-display" style="font-size: 0.85em; color: #555; font-weight:bold;"></span>
            <button onclick="logoutApp()" style="color: #dc3545; background: none; border: none; cursor: pointer; font-size:0.9em;">Sair</button>
        </div>
    </nav>

    <section id="view-funil" class="view-section active">
        <div class="funnel-filters">
            <button id="btn-novo-lead-funil" onclick="novoLeadDireto()" style="background:#28a745; color:white; border:none; padding:6px 12px; border-radius:4px; font-weight:bold; cursor:pointer;">+ Novo</button>
            <label>Atendente: <select id="f-funil-atend" onchange="renderFunnel()" style="margin:0; width:110px; padding:4px;"><option value="todos">Todos</option></select></label>
            <label>üìÖ De: <input type="date" id="f-funil-ini" onchange="renderFunnel()" style="margin:0; width:110px; padding:2px;"></label>
            <label>At√©: <input type="date" id="f-funil-fim" onchange="renderFunnel()" style="margin:0; width:110px; padding:2px;"></label>
            <label>Realizado: 
                <select id="f-funil-real" onchange="renderFunnel()" style="margin:0; padding:4px;">
                    <option value="todos">Todos</option>
                    <option value="com">Sim</option>
                    <option value="sem" selected>N√£o</option>
                </select>
            </label>
            <div style="display:flex; gap:8px; border-left:1px solid #ddd; padding-left:10px;">
                <label><input type="checkbox" checked onchange="toggleStarFilter(1)"> 1‚≠ê</label>
                <label><input type="checkbox" checked onchange="toggleStarFilter(2)"> 2‚≠ê</label>
                <label><input type="checkbox" checked onchange="toggleStarFilter(3)"> 3‚≠ê</label>
                <label><input type="checkbox" checked onchange="toggleStarFilter(4)"> 4‚≠ê</label>
                <label><input type="checkbox" checked onchange="toggleStarFilter(5)"> 5‚≠ê</label>
            </div>
            <label style="margin-left:10px; border-left:1px solid #ddd; padding-left:15px; color:var(--primary); font-weight:bold;">
                <input type="checkbox" id="f-funil-all" onchange="renderFunnel()" checked> Hist. Completo
            </label>

            <div style="display:flex; gap:8px; border-left:1px solid #ddd; padding-left:15px; margin-left:5px;">
                <span style="font-weight:bold; color:#555; margin-right:5px; align-self: center;">Etapas:</span>
                <label><input type="checkbox" id="f-col-novo" checked onchange="toggleFunnelCol('novo')"> Novos</label>
                <label><input type="checkbox" id="f-col-contatado" checked onchange="toggleFunnelCol('contatado')"> Contato</label>
                <label><input type="checkbox" id="f-col-orcamento" checked onchange="toggleFunnelCol('orcamento')"> Or√ßamento</label>
                <label><input type="checkbox" id="f-col-negociacao" checked onchange="toggleFunnelCol('negociacao')"> Negocia√ß√£o</label>
                <label><input type="checkbox" id="f-col-fechado" checked onchange="toggleFunnelCol('fechado')"> Fechados</label>
                <label><input type="checkbox" id="f-col-perdido" checked onchange="toggleFunnelCol('perdido')"> Perdidos</label>
            </div>
        </div>
        <div class="board">
            <div id="w-novo" class="column"><div class="column-header col-novo">Novos <span id="c-novo">0</span></div><div class="column-body" id="list-novo"></div></div>
            <div id="w-contatado" class="column"><div class="column-header col-contatado">Contato <span id="c-contatado">0</span></div><div class="column-body" id="list-contatado"></div></div>
            <div id="w-orcamento" class="column"><div class="column-header col-orcamento">Or√ßamento <span id="c-orcamento">0</span></div><div class="column-body" id="list-orcamento"></div></div>
            <div id="w-negociacao" class="column"><div class="column-header col-negociacao">Negocia√ß√£o <span id="c-negociacao">0</span></div><div class="column-body" id="list-negociacao"></div></div>
            <div id="w-fechado" class="column"><div class="column-header col-fechado">Fechados <span id="c-fechado">0</span></div><div class="column-body" id="list-fechado"></div></div>
            <div id="w-perdido" class="column"><div class="column-header col-perdido">Perdidos <span id="c-perdido">0</span></div><div class="column-body" id="list-perdido"></div></div>
        </div>
    </section>

    <section id="view-orcamentos" class="view-section">
        <div class="management-container">
            <div class="form-area" style="width: 450px;">
                <h2>‚è±Ô∏è Novo Apontamento</h2>
                <form id="form-apontamento-direto">
                    <input type="hidden" id="apt-orc-id-direto">
                    <input type="hidden" id="apt-index-editing-direto" value="-1"> 
                    
                    <label>Lead / Or√ßamento *</label>
                    <select id="orc-lead-direto" required onchange="populateHistSelectDireto(this.value)"><option value="">Selecione...</option></select>

                    <label>Hist√≥rico (Ref. Lead) *</label>
                    <select id="apt-hist-ref-direto" required></select>

                    <label>ID Or√ßamento (Max 10 caracteres)</label>
                    <input type="text" id="apt-id-externo-direto" maxlength="10" placeholder="Ex: ORC-123">

                    <label>Atendente *</label>
                    <select id="apt-atendente-direto" required></select>

                    <label id="lbl-prazo-direto">Prazo Final *</label>
                    <input type="datetime-local" id="apt-prazo-direto">

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <label>Dia/Hora In√≠cio</label>
                            <input type="datetime-local" id="apt-inicio-direto" onchange="checkRegistroDireto('inicio')">
                        </div>
                        <div>
                            <label>Registro In√≠cio (Auto)</label>
                            <input type="text" id="apt-reg-inicio-direto" readonly class="readonly-field" placeholder="Autom√°tico...">
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <label>Dia/Hora Fim</label>
                            <input type="datetime-local" id="apt-fim-direto" onchange="checkRegistroDireto('fim')">
                        </div>
                        <div>
                            <label>Registro Fim (Auto)</label>
                            <input type="text" id="apt-reg-fim-direto" readonly class="readonly-field" placeholder="Autom√°tico...">
                        </div>
                    </div>

                    <label>Status *</label>
                    <select id="apt-status-direto" required onchange="togglePrazoRequirement(this.value)">
                        <option value="Programado">Programado</option>
                        <option value="Iniciado">Iniciado</option>
                        <option value="Paralizado">Paralizado</option>
                        <option value="Conclu√≠do">Conclu√≠do</option>
                        <option value="Revisado">Revisado</option>
                        <option value="Revisado">Corre√ß√£o</option>
                        <option value="Enviado">Enviado</option>
                        <option value="Apresenta√ß√£o">Apresenta√ß√£o</option>
                        <option value="Solicitado Altera√ß√£o">Solicitado Altera√ß√£o</option>
                    </select>

                    <label>Observa√ß√µes</label>
                    <textarea id="apt-obs-direto" style="height:60px;"></textarea>

                    <button type="submit" class="btn-save" style="background:#17a2b8;" id="btn-save-apontamento">Gravar Apontamento</button>
                    <button type="button" onclick="limparFormApontamentoDireto()" style="width:100%; margin-top:5px; padding:8px; background:#6c757d; color:white; border:none; border-radius:6px; cursor:pointer;">Limpar / Novo</button>
                </form>
            </div>
            <div class="list-area">
                <h2 id="titulo-lista-apontamentos">Lista de Apontamentos</h2>
                
                <div class="filter-panel">
                    <div class="filter-row">
                        <div class="filter-item">
                            <label>Lead / Cliente</label>
                            <input type="text" id="f-orc-lead" oninput="renderTableOrcamentos()" placeholder="Nome do cliente..." style="margin-bottom:0;">
                        </div>
                        <div class="filter-item">
                            <label>Atendente</label>
                            <select id="f-orc-atend" onchange="renderTableOrcamentos()" style="margin-bottom:0;">
                                <option value="todos">Todos</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>Status</label>
                            <select id="f-orc-status" onchange="renderTableOrcamentos()" style="margin-bottom:0;">
                                <option value="todos">Todos os Status</option>
                                <option value="Programado">Programado</option>
                                <option value="Iniciado">Iniciado</option>
                                <option value="Paralizado">Paralizado</option>
                                <option value="Conclu√≠do">Conclu√≠do</option>
                                <option value="Revisado">Revisado</option>
                                <option value="Enviado">Enviado</option>
                                <option value="Apresenta√ß√£o">Apresenta√ß√£o</option>
                                <option value="Solicitado Altera√ß√£o">Solicitado Altera√ß√£o</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-check-group">
                        <label style="font-size: 1.5em;"><input type="checkbox" id="f-orc-no-start" onchange="renderTableOrcamentos()" style="width: auto; margin-right: 8px;"> In√≠cio n√£o apontado</label>
                        <label style="font-size: 1.5em;"><input type="checkbox" id="f-orc-no-end" onchange="renderTableOrcamentos()" style="width: auto; margin-right: 8px;"> Fim n√£o apontado</label>
                    </div>
                </div>

                <div class="table-wrapper">
                    <table id="table-orcamentos">
                        <thead>
                            <tr>
                                <th style="width:230px;">Lead / ID</th>
                                <th style="width:100px;">Ref. Lead</th>
                                <th>Hist√≥rico de Trabalhos</th>
                                <th style="width:110px; text-align:center;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <dialog id="dialog-apontamento">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <h3 style="margin:0">‚è±Ô∏è Detalhes do Apontamento</h3>
            <button onclick="document.getElementById('dialog-apontamento').close()" style="border:none; background:none; font-size:1.5em; cursor:pointer;">&times;</button>
        </div>
        <div id="modal-info-lead" style="font-weight:bold; color:var(--primary); margin-bottom:10px; font-size:0.9em;"></div>
        <div id="lista-historico-apontamentos" style="max-height:400px; overflow-y:auto;"></div>
    </dialog>

    <section id="view-leads" class="view-section">
        <div class="management-container">
            <div class="form-area" id="lead-main-container">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h2>Dados B√°sicos</h2>
                    <button onclick="limparFormLead()" style="padding:5px 10px; cursor:pointer;">Limpar / Novo</button>
                </div>
                <form id="form-lead-main">
                    <input type="hidden" id="lead-id">
                    <label>Cliente *</label>
                    <select id="lead-cliente" required onchange="showInfo('cliente', this.value)"><option value="">Carregando...</option></select>
                    <span id="info-cliente" class="contact-info-display"></span>

                    <label>Origem *</label>
                    <select id="lead-origem" required>
                        <option>Instagram</option><option>Tiktok</option><option>Facebook</option><option>Site</option><option>Google</option>
                        <option>Prospec√ß√£o</option><option>Manuten√ß√£o</option><option>Indica√ß√£o</option><option>Cliente</option>
			            <option>Reativa√ß√£o</option><option>Outros</option>
                    </select>

                    <label>Indica√ß√£o</label>
                    <select id="lead-indicacao" onchange="showInfo('indicacao', this.value)"><option value="">Selecione...</option></select>
                    <span id="info-indicacao" class="contact-info-display"></span>

                    <div class="obra-section pvc-bg">
                        <div class="obra-title">Obra PVC</div>
                        <div><label>Metragem (m¬≤)</label><input type="text" id="lead-pvc-metragem" class="mask-m2"></div>
                        <div><label>Qtd Pe√ßas</label><input type="number" id="lead-pvc-pecas"></div>
                        <div><label>Margem Padr√£o (%)</label><input type="text" id="lead-pvc-margem-padrao" class="mask-percent"></div>
                        <div><label>Margem Especial (%)</label><input type="text" id="lead-pvc-margem-especial" class="mask-percent"></div>
                        <div><label>Valor Or√ßamento (R$)</label><input type="text" id="lead-pvc-valor-orcamento" class="mask-currency"></div>
                        <div><label>Valor Pedido (R$)</label><input type="text" id="lead-pvc-valor-pedido" class="mask-currency"></div>
                    </div>

                    <div class="obra-section alu-bg">
                        <div class="obra-title">Obra Alum√≠nio</div>
                        <div><label>Metragem (m¬≤)</label><input type="text" id="lead-alu-metragem" class="mask-m2"></div>
                        <div><label>Qtd Pe√ßas</label><input type="number" id="lead-alu-pecas"></div>
                        <div><label>Margem Padr√£o (%)</label><input type="text" id="lead-alu-margem-padrao" class="mask-percent"></div>
                        <div><label>Margem Especial (%)</label><input type="text" id="lead-alu-margem-especial" class="mask-percent"></div>
                        <div><label>Valor Or√ßamento (R$)</label><input type="text" id="lead-alu-valor-orcamento" class="mask-currency"></div>
                        <div><label>Valor Pedido (R$)</label><input type="text" id="lead-alu-valor-pedido" class="mask-currency"></div>
                    </div>

                    <label>Previs√£o Instala√ß√£o</label><input type="date" id="lead-previsao">
                    
                    <label>Construtora</label>
                    <select id="lead-construtora" onchange="showInfo('construtora', this.value)"><option value="">Selecione...</option></select>
                    <span id="info-construtora" class="contact-info-display"></span>

                    <label>Adm da Obra</label>
                    <select id="lead-adm-obra" onchange="showInfo('adm-obra', this.value)"><option value="">Selecione...</option></select>
                    <span id="info-adm-obra" class="contact-info-display"></span>

                    <label>Arquiteto</label>
                    <select id="lead-arquiteto" onchange="showInfo('arquiteto', this.value)"><option value="">Selecione...</option></select>
                    <span id="info-arquiteto" class="contact-info-display"></span>

                    <label>Respons√°vel Obra</label>
                    <select id="lead-responsavel" onchange="showInfo('responsavel', this.value)"><option value="">Selecione...</option></select>
                    <span id="info-responsavel" class="contact-info-display"></span>

                    <button type="submit" class="btn-save" id="btn-save-lead-main">Salvar Dados B√°sicos</button>
                </form>

                <div id="area-arquivos" style="display:none; margin-top:20px;">
                    <hr><h3>üìÅ Arquivos</h3>
                    <input type="file" id="lead-file-input" style="display:none" onchange="handleFileUpload(this.files)">
                    <button type="button" onclick="document.getElementById('lead-file-input').click()" class="btn-save" style="background:#6c757d; margin-bottom:10px;" id="btn-upload-file">+ Upload de Arquivo</button>
                    <div id="lead-files-list"></div>
                </div>

                <div id="area-historico" style="display:none; margin-top:20px;">
                    <hr><h3>üìú Hist√≥rico</h3>
                    <form id="form-historico" style="background:#f9f9f9; padding:10px; border-radius:6px; border:1px solid #eee;">
                        <input type="hidden" id="hist-index" value="">
                        <label>Atendente *</label><select id="hist-atendente" required></select>
                        
                        <label>Contato *</label>
                        <select id="hist-contato-tipo" required onchange="handleHistContato(this.value)">
                            <option value="">Selecione...</option>
                            <option value="Propriet√°rio">Propriet√°rio</option>
                            <option value="Arquiteto">Arquiteto</option>
                            <option value="Respons√°vel Obra">Respons√°vel Obra</option>
                            <option value="Adm Obra">Adm Obra</option>
                            <option value="Construtora">Construtora</option>
                            <option value="Outra">Outra</option>
                        </select>
                        <div id="area-contato-outra" style="display:none">
                            <label>Selecionar Cadastro</label>
                            <select id="hist-contato-id" onchange="updateHistContactDisplay(this.value)"></select>
                        </div>
                        <span id="info-hist-contato" class="contact-info-display" style="color: #28a745; font-weight: bold;"></span>

                        <label>Etapa *</label><select id="hist-etapa" required><option value="novo">Novo</option><option value="contatado">Contato</option><option value="orcamento">Or√ßamento</option><option value="negociacao">Negocia√ß√£o</option><option value="fechado">Fechado</option><option value="perdido">Perdido</option></select>
                        <label>Classifica√ß√£o</label>
                        <select id="hist-temp">
                            <option value="">Sem estrelas</option>
                            <option value="1">‚≠ê 1 Estrela</option>
                            <option value="2">‚≠ê‚≠ê 2 Estrelas</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê 3 Estrelas</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4 Estrelas</option>
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 Estrelas</option>
                        </select>
                        <div style="display:flex; gap:10px;">
                            <div style="flex:1"><label>Programado</label><input type="datetime-local" id="hist-prog"></div>
                            <div style="flex:1"><label>Realizado</label><input type="datetime-local" id="hist-real"></div>
                        </div>

                        <label>Resultado da Intera√ß√£o *</label>
                        <select id="hist-resultado">
                            <option value="">Selecione...</option>
                            <option value="Sucesso">Sucesso</option>
                            <option value="Insucesso">Insucesso</option>
                        </select>
                        
                        <label>√öltima altera√ß√£o 'Realizado'</label>
                        <input type="text" id="hist-upd-real" readonly style="background:#f0f0f0; color:#666; font-size:0.85em;">

                        <label>Resumo</label><textarea id="hist-resumo" required style="height:60px;"></textarea>
                        <button type="submit" class="btn-save" style="background:#17a2b8" id="btn-save-hist">+ Gravar Intera√ß√£o</button>
                    </form>
                    <div id="timeline-list" style="margin-top:15px;"></div>
                </div>
            </div>
            <div class="list-area">
                <h2>Leads</h2>
                
                <div class="filter-panel">
                    <div class="filter-row" style="flex-wrap: nowrap; gap: 8px;">
                        <div class="filter-item" style="flex: 1.5;">
                            <label>Cliente:</label>
                            <input type="text" id="f-leads-cliente" oninput="renderTableLeads()" placeholder="Nome do cliente..." style="margin-bottom:0;">
                        </div>
                        <div class="filter-item">
                            <label>Atendente:</label>
                            <select id="f-leads-atend" onchange="renderTableLeads()" style="margin-bottom:0;">
                                <option value="todos">Todos</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>Origem:</label>
                            <select id="f-leads-origem" onchange="renderTableLeads()" style="margin-bottom:0;">
                                <option value="todos">Todas</option>
                                <option>Cliente</option>
                                <option>Facebook</option>
                                <option>Google</option>
                                <option>Indica√ß√£o</option>
                                <option>Instagram</option>
                                <option>Manuten√ß√£o</option>
                                <option>Outros</option>
                                <option>Prospec√ß√£o</option>
                                <option>Reativa√ß√£o</option>
                                <option>Site</option>
                                <option>Tiktok</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>Etapa:</label>
                            <select id="f-leads-etapa" onchange="renderTableLeads()" style="margin-bottom:0;">
                                <option value="todos">Todas</option>
                                <option value="contatado">Contato</option>
                                <option value="fechado">Fechado</option>
                                <option value="negociacao">Negocia√ß√£o</option>
                                <option value="novo">Novo</option>
                                <option value="orcamento">Or√ßamento</option>
                                <option value="perdido">Perdido</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="table-wrapper">
                    <table id="table-leads">
                        <thead>
                            <tr>
                                <th>Desde</th>
                                <th style="cursor:pointer; user-select:none;" onclick="toggleLeadSort()" title="Clique para ordenar">Cliente ‚ÜïÔ∏è</th>
                                <th>Etapa</th>
                                <th style="width:140px; text-align:center;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <section id="view-cadastro" class="view-section">
        <div class="management-container">
            <div class="form-area" style="width:400px;">
                <h2>Novo Registro</h2>
                <form id="form-cliente">
                    <input type="hidden" id="cli-id">
                    <label>Nome *</label><input type="text" id="cli-nome" required>
                    <label>Tipo *</label>
                    <select id="cli-tipo" required>
                        <option>Cliente</option><option>Arquiteto</option><option>Respons√°vel Obra</option>
                        <option>Construtora</option><option>Adm da Obra</option><option>Outro</option>
                    </select>
                    <label>Status</label><select id="cli-status"><option>Novo</option><option>Ativo</option><option>Inativo</option></select>
                    <label>Telefone/Whats</label><input type="text" id="cli-telefone" placeholder="(99) 99999-9999">
                    <label>E-mail</label><input type="email" id="cli-email">
                    <label>Cidade</label><input type="text" id="cli-cidade">
                    <label>Endere√ßo</label><input type="text" id="cli-endereco">
                    <button type="submit" class="btn-save" id="btn-save-cliente">Salvar</button>
                </form>
            </div>
            <div class="list-area">
                <h2>Cadastro Geral</h2>
                
                <div class="filter-panel">
                    <div class="filter-row">
                        <div class="filter-item">
                            <label>Nome:</label>
                            <input type="text" id="f-cli-nome" oninput="renderTableClientes()" placeholder="Filtrar nome..." style="margin-bottom:0;">
                        </div>
                        <div class="filter-item">
                            <label>Tipo:</label>
                            <select id="f-cli-tipo" onchange="renderTableClientes()" style="margin-bottom:0;">
                                <option value="todos">Todos</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>Cidade:</label>
                            <input type="text" id="f-cli-cidade" oninput="renderTableClientes()" placeholder="Filtrar cidade..." style="margin-bottom:0;">
                        </div>
                        <div class="filter-item">
                            <label>Whats:</label>
                            <input type="text" id="f-cli-whats" oninput="renderTableClientes()" placeholder="Filtrar telefone..." style="margin-bottom:0;">
                        </div>
                    </div>
                </div>

                <div class="table-wrapper">
                    <table id="table-clientes">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Tipo</th>
                                <th>Cidade</th>
                                <th style="width:80px;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <section id="view-atendentes" class="view-section">
        <div class="management-container">
            <div class="form-area" style="width:400px;">
                <h2>Equipe</h2>
                <form id="form-atendente">
                    <input type="hidden" id="atend-id">
                    <label>Nome *</label><input type="text" id="atend-nome" required>
                    <label>Email</label><input type="email" id="atend-email" required>
                    <label>Whats</label><input type="text" id="atend-whats" placeholder="(99) 99999-9999">
                    <button type="submit" class="btn-save" id="btn-save-atendente">Salvar</button>
                </form>
            </div>
            <div class="list-area"><h2>Atendentes</h2><div class="table-wrapper"><table id="table-atendentes"><thead><tr><th>Nome</th><th>Whats</th><th style="width:80px;">A√ß√µes</th></tr></thead><tbody></tbody></table></div></div>
        </div>
    </section>

    <section id="view-dashboard" class="view-section">
        <div class="dashboard-grid">
            <div class="filter-bar">
                <div class="filter-group"><label>In√≠cio</label><input type="date" id="dash-inicio"></div>
                <div class="filter-group"><label>Fim</label><input type="date" id="dash-fim"></div>
                <div class="filter-group"><label>Atendente</label><select id="dash-atendente"><option value="todos">Todos</option></select></div>
                <button class="btn-save" style="width:auto; height:42px; padding:0 20px;" onclick="processarDashboard()">Atualizar</button>
            </div>

            <div class="charts-container">
                <div class="chart-box">
                    <div class="chart-title">üìç Leads por Origem</div>
                    <canvas id="chartOrigem"></canvas>
                </div>
                <div class="chart-box">
                    <div class="chart-title">üìÖ Novos Leads (Por Dia)</div>
                    <canvas id="chartLeadsDay"></canvas>
                </div>
                <div class="chart-box">
                    <div class="chart-title">‚è±Ô∏è Performance e Atraso M√©dio</div>
                    <div id="delay-metric" class="metric-badge" style="display:none"></div>
                    <canvas id="chartPerformance"></canvas>
                </div>
                <div class="chart-box">
                    <div class="chart-title">‚è≥ M√©dia de Dias por Etapa</div>
                    <canvas id="chartStageTime"></canvas>
                </div>
                <div class="chart-box chart-box-wide">
                    <div class="chart-title">üöÄ Evolu√ß√£o: Tempo para Mudar de Etapa (M√©dias)</div>
                    <canvas id="chartCycleTime"></canvas>
                </div>
            </div>

            <div class="list-area" style="min-height:300px; margin-top:15px; flex:none;">
                <h3 style="margin:0 0 10px 0">üìã Relat√≥rio Filtrado <span id="dash-count" style="font-size:0.8em; font-weight:normal; color:#666"></span></h3>
                <div class="table-wrapper">
                    <table id="dash-table">
                        <thead><tr><th>Data</th><th>Etapa</th><th>Cliente</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <section id="view-usuarios" class="view-section">
        <div class="management-container">
            <div class="form-area" style="width:400px; background:white;">
                <h2 style="margin-top:0;">Permiss√µes de Acesso</h2>
                <form id="form-permissoes">
                    <input type="hidden" id="perm-user-uid">
                    <label>E-mail do Usu√°rio Selecionado</label>
                    <input type="email" id="perm-user-email" readonly class="readonly-field">
                    
                    <label>Perfil de Sistema</label>
                    <select id="perm-user-perfil" required>
                        <option value="admin">Administrador (Total)</option>
                        <option value="user" selected>Padr√£o (Configur√°vel)</option>
                    </select>

                    <div id="area-config-perms">
                        <div class="perm-group">
                            <h4>üìä Funil & Dashboard</h4>
                            <div class="perm-row">
                                <label><input type="checkbox" id="p-funil-ver"> Ver Funil</label>
                                <label><input type="checkbox" id="p-dash-ver"> Ver Dash</label>
                            </div>
                        </div>

                        <div class="perm-group">
                            <h4>üéØ Leads</h4>
                            <div class="perm-row">
                                <label><input type="checkbox" id="p-leads-ver"> Ver</label>
                                <label><input type="checkbox" id="p-leads-gravar"> Gravar</label>
                                <label><input type="checkbox" id="p-leads-excluir"> Excluir</label>
                            </div>
                        </div>

                        <div class="perm-group">
                            <h4>üïê Or√ßamentos (Apontamentos)</h4>
                            <div class="perm-row">
                                <label><input type="checkbox" id="p-orc-ver"> Ver</label>
                                <label><input type="checkbox" id="p-orc-gravar"> Gravar</label>
                                <label><input type="checkbox" id="p-orc-excluir"> Excluir</label>
                            </div>
                        </div>

                        <div class="perm-group">
                            <h4>üë• Cadastros & Equipe</h4>
                            <div class="perm-row">
                                <label><input type="checkbox" id="p-cad-ver"> Ver</label>
                                <label><input type="checkbox" id="p-cad-gravar"> Gravar</label>
                                <label><input type="checkbox" id="p-cad-excluir"> Excluir</label>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn-save" style="margin-top: 10px;">Salvar Permiss√µes</button>
                    <div style="text-align: center; margin-top: 15px;">
                        <button type="button" onclick="removerUsuarioFirestore()" style="color:var(--danger); background:none; border:none; cursor:pointer; font-size:0.9em;">üóëÔ∏è Remover Usu√°rio do Firestore</button>
                    </div>
                </form>
            </div>
            
            <div class="list-area" style="background:white;">
                <h2 style="margin-top:0;">Usu√°rios Cadastrados</h2>
                <div class="table-wrapper">
                    <table id="table-usuarios">
                        <thead>
                            <tr>
                                <th>E-mail</th>
                                <th>Perfil</th>
                                <th style="width:80px; text-align:center;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, orderBy, onSnapshot, serverTimestamp, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyDxikX_gLL3l2fQuHmSZUai5-1CgBGp2ao", authDomain: "orcamento-80415.firebaseapp.com", projectId: "orcamento-80415", storageBucket: "orcamento-80415.firebasestorage.app", messagingSenderId: "767008319616", appId: "1:767008319616:web:78b45f56f92ce7a5091e65" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        // VARI√ÅVEIS DE ESTADO
        let listaLeads=[], listaClientes=[], listaAtendentes=[], listaOrcamentos=[], listaUsuarios=[], leadAtual=null, starFilters=[1,2,3,4,5];
        let chartOrigem=null, chartLeadsDay=null, chartPerf=null, chartStageTime=null, chartCycleTime=null;
        let leadSortAsc = false;
        
        // AUTH & RBAC (Role-Based Access Control)
        let currentUser = null;
        let currentPerms = null;
        let listenersAtivos = []; // Para poder desligar ao dar logoff

        const defaultPermissoes = {
            funil_dash: { ver: true, ver_dash: true },
            leads: { ver: true, gravar: true, excluir: false },
            orcamentos: { ver: true, gravar: true, excluir: false },
            cadastros: { ver: true, gravar: true, excluir: false }
        };

        const adminPermissoes = {
            funil_dash: { ver: true, ver_dash: true },
            leads: { ver: true, gravar: true, excluir: true },
            orcamentos: { ver: true, gravar: true, excluir: true },
            cadastros: { ver: true, gravar: true, excluir: true }
        };

        function formatBR(iso) { if(!iso) return '-'; const d=new Date(iso); return d.toLocaleDateString('pt-BR')+' '+d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}); }
        
        const cleanNum = (v) => v.replace(/\D/g, "");
        const applyMasks = () => {
            document.querySelectorAll('.mask-m2').forEach(el => {
                el.addEventListener('input', (e) => {
                    let v = e.target.value.replace(/[^\d,]/g, "");
                    const parts = v.split(",");
                    if (parts.length > 2) v = parts[0] + "," + parts[1];
                    e.target.value = v;
                });
                el.addEventListener('blur', (e) => {
                    let v = e.target.value.replace(/[^\d,]/g, "");
                    if (!v) return;
                    let num = parseFloat(v.replace(",", "."));
                    if (!isNaN(num)) {
                        e.target.value = num.toLocaleString('pt-BR', {minimumFractionDigits: 1, maximumFractionDigits: 1}) + " m2";
                    }
                });
                el.addEventListener('focus', (e) => {
                    e.target.value = e.target.value.replace(" m2", "");
                });
            });

            document.querySelectorAll('.mask-percent').forEach(el => {
                el.addEventListener('input', (e) => { e.target.value = cleanNum(e.target.value); });
                el.addEventListener('blur', (e) => { if (e.target.value && !e.target.value.includes("%")) { e.target.value = e.target.value + "%"; } });
                el.addEventListener('focus', (e) => { e.target.value = e.target.value.replace("%", ""); });
            });

            document.querySelectorAll('.mask-currency').forEach(el => {
                el.addEventListener('input', (e) => { e.target.value = cleanNum(e.target.value); });
                el.addEventListener('blur', (e) => {
                    let v = cleanNum(e.target.value);
                    if (!v) return;
                    let num = parseInt(v);
                    e.target.value = "R$ " + num.toLocaleString('pt-BR');
                });
                el.addEventListener('focus', (e) => { e.target.value = cleanNum(e.target.value); });
            });
        };

        const maskPhone = (v) => {
            v = v.replace(/\D/g, "");
            if (v.length > 11) v = v.substring(0, 11);
            v = v.replace(/^(\d{2})(\d)/g, "($1) $2");
            v = v.replace(/(\d{5})(\d)/, "$1-$2");
            return v;
        };

        document.querySelectorAll('input[id$="telefone"], input[id$="whats"]').forEach(el => {
            el.addEventListener('input', (e) => e.target.value = maskPhone(e.target.value));
        });

        window.showInfo = (field, id) => {
            const span = document.getElementById('info-' + field);
            const item = listaClientes.find(c => c.id === id);
            span.innerText = item ? `üìû ${item.telefone || '-'} | üìß ${item.email || '-'}` : "";
        };

        // ========== AUTHENTICATION ==========
        let loginMode = 'login';
        document.getElementById('toggle-login-mode').addEventListener('click', (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-login-submit');
            const toggleLink = document.getElementById('toggle-login-mode');
            if (loginMode === 'login') {
                loginMode = 'register';
                btn.innerText = "Criar Conta";
                toggleLink.innerText = "J√° tem conta? Entrar";
            } else {
                loginMode = 'login';
                btn.innerText = "Entrar";
                toggleLink.innerText = "N√£o tem conta? Cadastrar-se";
            }
        });

        document.getElementById('form-login').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('log-email').value;
            const pass = document.getElementById('log-pass').value;
            
            try {
                if (loginMode === 'login') {
                    await signInWithEmailAndPassword(auth, email, pass);
                } else {
                    await createUserWithEmailAndPassword(auth, email, pass);
                }
            } catch (error) {
                alert("Erro: " + error.message);
            }
        });

        window.logoutApp = async () => {
            if(confirm("Deseja sair do sistema?")) {
                await signOut(auth);
            }
        };

        // L√ìGICA DE APLICA√á√ÉO DAS PERMISS√ïES NAS TELAS
        function aplicarPermissoesInterface() {
            if (!currentPerms) return;
            const p = currentPerms;
            const isAdm = currentUser.perfil === 'admin';

            // Menu Navega√ß√£o
            document.getElementById('btn-funil').style.display = p.funil_dash.ver ? 'block' : 'none';
            document.getElementById('btn-dashboard').style.display = p.funil_dash.ver_dash ? 'block' : 'none';
            document.getElementById('btn-leads').style.display = p.leads.ver ? 'block' : 'none';
            document.getElementById('btn-orcamentos').style.display = p.orcamentos.ver ? 'block' : 'none';
            document.getElementById('btn-cadastro').style.display = p.cadastros.ver ? 'block' : 'none';
            document.getElementById('btn-atendentes').style.display = p.cadastros.ver ? 'block' : 'none';
            document.getElementById('btn-usuarios').style.display = isAdm ? 'block' : 'none';

            // Bot√µes de Adicionar/Gravar (Esconde/Desabilita se n√£o tiver permiss√£o)
            document.getElementById('btn-novo-lead-funil').style.display = p.leads.gravar ? 'inline-block' : 'none';
            document.getElementById('btn-save-lead-main').disabled = !p.leads.gravar;
            document.getElementById('btn-save-hist').disabled = !p.leads.gravar;
            document.getElementById('btn-upload-file').disabled = !p.leads.gravar;
            
            document.getElementById('btn-save-apontamento').disabled = !p.orcamentos.gravar;
            
            document.getElementById('btn-save-cliente').disabled = !p.cadastros.gravar;
            document.getElementById('btn-save-atendente').disabled = !p.cadastros.gravar;

            // Para for√ßar o redirecionamento caso esteja numa tela n√£o permitida
            let activeView = document.querySelector('.view-section.active').id;
            activeView = activeView.replace('view-', '');
            let allow = true;
            if (activeView === 'funil' && !p.funil_dash.ver) allow = false;
            if (activeView === 'dashboard' && !p.funil_dash.ver_dash) allow = false;
            if (activeView === 'leads' && !p.leads.ver) allow = false;
            if (activeView === 'orcamentos' && !p.orcamentos.ver) allow = false;
            if ((activeView === 'cadastro' || activeView === 'atendentes') && !p.cadastros.ver) allow = false;
            if (activeView === 'usuarios' && !isAdm) allow = false;
            
            if (!allow) {
                // Tenta jogar pra primeira permitida
                if(p.funil_dash.ver) switchView('funil');
                else if(p.leads.ver) switchView('leads');
                else if(p.orcamentos.ver) switchView('orcamentos');
                else if(p.cadastros.ver) switchView('cadastro');
            }

            // Re-renderizar listas para aplicar restri√ß√µes de bot√µes de edi√ß√£o/exclus√£o em tempo real
            renderTableClientes();
            renderTableLeads();
            renderTableOrcamentos();
            renderFunnel();
        }

        // MONITORA ESTADO DO LOGIN
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('main-nav').style.display = 'flex';
                document.getElementById('user-info-display').innerText = user.email;

                const userEmailLower = user.email.trim().toLowerCase();
                const isMaster = userEmailLower === 'claiton@perfectaesquadrias.com.br';

                // Busca ou Cria Documento do Usu√°rio
                const userDoc = await getDoc(doc(db, "usuarios", user.uid));
                
                // For√ßa a atualiza√ß√£o se for o Master e o perfil ainda n√£o estiver gravado como admin
                if (!userDoc.exists() || (isMaster && userDoc.data().perfil !== 'admin')) {
                    let perms = defaultPermissoes;
                    let perfil = 'user';
                    if (isMaster) {
                        perms = adminPermissoes;
                        perfil = 'admin';
                    }
                    const newUserObj = { email: userEmailLower, perfil, permissoes: perms, created_at: serverTimestamp() };
                    await setDoc(doc(db, "usuarios", user.uid), newUserObj);
                    currentUser = { uid: user.uid, ...newUserObj };
                } else {
                    currentUser = { uid: user.uid, ...userDoc.data() };
                }

                // CORRE√á√ÉO: Failsafe para garantir que o objeto de permiss√µes est√° sempre √≠ntegro
                // e que o usu√°rio Master sempre tenha permiss√£o total for√ßada, evitando erros de DB.
                if (isMaster || currentUser.perfil === 'admin') {
                    currentPerms = adminPermissoes;
                } else {
                    // Garante que a estrutura exista mesmo em documentos antigos/incompletos
                    currentPerms = {
                        funil_dash: currentUser.permissoes?.funil_dash || defaultPermissoes.funil_dash,
                        leads: currentUser.permissoes?.leads || defaultPermissoes.leads,
                        orcamentos: currentUser.permissoes?.orcamentos || defaultPermissoes.orcamentos,
                        cadastros: currentUser.permissoes?.cadastros || defaultPermissoes.cadastros
                    };
                }
                
                aplicarPermissoesInterface();
                iniciarListenersDeDados();
                
            } else {
                // Reset Completo ao sair
                document.getElementById('login-overlay').style.display = 'flex';
                document.getElementById('main-nav').style.display = 'none';
                document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
                
                listenersAtivos.forEach(unsub => unsub()); // Desliga sync do firebase
                listenersAtivos = [];
                listaLeads=[]; listaClientes=[]; listaAtendentes=[]; listaOrcamentos=[]; listaUsuarios=[];
                currentUser = null; currentPerms = null;
                document.getElementById('form-login').reset();
            }
        });


        // ========== CARREGAMENTO DE DADOS ==========
        function iniciarListenersDeDados() {
            if (!currentPerms) return;
            
            // Atendentes
            if (currentPerms.cadastros.ver) {
                listenersAtivos.push(onSnapshot(collection(db, "atendentes"), (snap) => {
                    listaAtendentes = snap.docs.map(d => ({...d.data(), id: d.id})).sort((a,b) => a.nome.localeCompare(b.nome));
                    const tb = document.querySelector('#table-atendentes tbody'); tb.innerHTML = '';
                    const selects = ['hist-atendente', 'f-funil-atend', 'dash-atendente', 'apt-atendente-direto', 'f-orc-atend', 'f-leads-atend'];
                    selects.forEach(id => { const el = document.getElementById(id); if(el && el.tagName === 'SELECT') { const firstOption = el.querySelector('option'); el.innerHTML = ''; if(firstOption) el.appendChild(firstOption); } });
                    listaAtendentes.forEach(a => {
                        const btnEdit = currentPerms.cadastros.gravar ? `<button class="btn-icon" onclick="event.stopPropagation(); editarAtend('${a.id}')">‚úèÔ∏è</button>` : '';
                        const btnDel = currentPerms.cadastros.excluir ? `<button class="btn-icon" onclick="event.stopPropagation(); excluirAtend('${a.id}')" style="color:red">üóëÔ∏è</button>` : '';
                        tb.innerHTML += `<tr onclick="if(${currentPerms.cadastros.gravar}) editarAtend('${a.id}')" style="${currentPerms.cadastros.gravar?'cursor:pointer':''}"><td>${a.nome}</td><td>${a.whats||'-'}</td><td>${btnEdit} ${btnDel}</td></tr>`;
                        const opt = `<option value="${a.nome}">${a.nome}</option>`;
                        selects.forEach(id => { const el = document.getElementById(id); if(el && el.tagName === 'SELECT') el.innerHTML += opt; });
                    });
                }));
            }

            // Clientes
            if (currentPerms.cadastros.ver || currentPerms.leads.ver) {
                listenersAtivos.push(onSnapshot(collection(db, "clientes"), (snap) => {
                    listaClientes = snap.docs.map(d => ({...d.data(), id: d.id})).sort((a,b) => a.nome_empresa.localeCompare(b.nome_empresa));
                    
                    const selects = ['lead-cliente', 'lead-indicacao', 'lead-construtora', 'lead-adm-obra', 'lead-arquiteto', 'lead-responsavel', 'hist-contato-id'];
                    selects.forEach(id => { const el = document.getElementById(id); if(el && el.tagName === 'SELECT') el.innerHTML = '<option value="">Selecione...</option>'; });
                    
                    const fTipoSel = document.getElementById('f-cli-tipo');
                    if(fTipoSel) {
                        const valAntigo = fTipoSel.value;
                        const tiposUnicos = [...new Set(listaClientes.map(c => c.tipo))].filter(Boolean).sort();
                        fTipoSel.innerHTML = '<option value="todos">Todos</option>';
                        tiposUnicos.forEach(t => fTipoSel.innerHTML += `<option value="${t}">${t}</option>`);
                        fTipoSel.value = tiposUnicos.includes(valAntigo) ? valAntigo : 'todos';
                    }

                    listaClientes.forEach(c => {
                        const opt = `<option value="${c.id}">${c.nome_empresa}</option>`;
                        selects.forEach(id => { const el = document.getElementById(id); if(el && el.tagName === 'SELECT') el.innerHTML += opt; });
                    });

                    if(currentPerms.cadastros.ver) renderTableClientes();
                    if(currentPerms.leads.ver) renderTableLeads();
                }));
            }

            // Leads
            if (currentPerms.leads.ver || currentPerms.funil_dash.ver) {
                listenersAtivos.push(onSnapshot(query(collection(db, "leads"), orderBy("created_at", "desc")), (snap) => {
                    listaLeads = snap.docs.map(d => ({...d.data(), id: d.id}));
                    if(currentPerms.funil_dash.ver) renderFunnel(); 
                    if(currentPerms.leads.ver) renderTableLeads();
                    
                    const selOrcLead = document.getElementById('orc-lead-direto');
                    if(selOrcLead) {
                        selOrcLead.innerHTML = '<option value="">Selecione...</option>';
                        [...listaLeads].sort((a, b) => (a.nome_cliente_cache || "").localeCompare(b.nome_cliente_cache || "")).forEach(l => { 
                            selOrcLead.innerHTML += `<option value="${l.id}">${l.nome_cliente_cache}</option>`;
                        });
                    }
                    if(leadAtual) { const updated = listaLeads.find(l => l.id === leadAtual.id); if(updated) { leadAtual = updated; renderArquivos(); renderTimeline(); } }
                }));
            }

            // Apontamentos (Or√ßamentos)
            if (currentPerms.orcamentos.ver || currentPerms.funil_dash.ver) {
                listenersAtivos.push(onSnapshot(query(collection(db, "apontamentos"), orderBy("updated_at", "desc")), (snap) => {
                    listaOrcamentos = snap.docs.map(d => ({...d.data(), id: d.id}));
                    if(currentPerms.orcamentos.ver) renderTableOrcamentos();
                    if(currentPerms.funil_dash.ver) renderFunnel(); 
                }));
            }

            // Tela de Usu√°rios (Apenas Admin)
            if (currentUser && currentUser.perfil === 'admin') {
                listenersAtivos.push(onSnapshot(collection(db, "usuarios"), (snap) => {
                    let rawUsers = snap.docs.map(d => ({...d.data(), uid: d.id}));
                    
                    // Deduplicar usu√°rios por e-mail na visualiza√ß√£o
                    let uniqueUsers = [];
                    let seenEmails = new Set();
                    for(let u of rawUsers) {
                        let e = (u.email || "").toLowerCase().trim();
                        if(!seenEmails.has(e)) {
                            seenEmails.add(e);
                            uniqueUsers.push(u);
                        }
                    }
                    listaUsuarios = uniqueUsers;
                    renderTableUsuarios();
                }));
            }
        }

        // ========== RENDER FUNCS (COM CHECAGEM DE RBAC) ==========
        window.renderTableClientes = () => {
            const tb = document.querySelector('#table-clientes tbody'); 
            if(!tb || !currentPerms) return;
            tb.innerHTML = '';
            
            const fNome = document.getElementById('f-cli-nome').value.toLowerCase();
            const fTipo = document.getElementById('f-cli-tipo').value;
            const fCidade = document.getElementById('f-cli-cidade').value.toLowerCase();
            const fWhats = document.getElementById('f-cli-whats').value.toLowerCase();

            listaClientes.forEach(c => {
                const matchNome = (c.nome_empresa || "").toLowerCase().includes(fNome);
                const matchTipo = fTipo === 'todos' || c.tipo === fTipo;
                const matchCidade = (c.cidade || "").toLowerCase().includes(fCidade);
                const matchWhats = (c.telefone || "").toLowerCase().includes(fWhats);

                if (matchNome && matchTipo && matchCidade && matchWhats) {
                    const btnEdit = currentPerms.cadastros.gravar ? `<button class="btn-icon" onclick="event.stopPropagation(); editarCli('${c.id}')">‚úèÔ∏è</button>` : '';
                    const btnDel = currentPerms.cadastros.excluir ? `<button class="btn-icon" onclick="event.stopPropagation(); excluirCli('${c.id}')" style="color:red">üóëÔ∏è</button>` : '';
                    tb.innerHTML += `<tr onclick="if(${currentPerms.cadastros.gravar}) editarCli('${c.id}')" style="${currentPerms.cadastros.gravar?'cursor:pointer':''}">
                        <td>${c.nome_empresa}</td>
                        <td>${c.tipo||'Cliente'}</td>
                        <td>${c.cidade||''}</td>
                        <td>${btnEdit} ${btnDel}</td>
                    </tr>`;
                }
            });
        };

        window.renderTableOrcamentos = () => {
            const tb = document.querySelector('#table-orcamentos tbody');
            if(!tb || !currentPerms) return;
            const fAtend = document.getElementById('f-orc-atend').value;
            const fLead = document.getElementById('f-orc-lead').value.toLowerCase();
            const fStatus = document.getElementById('f-orc-status').value;
            const fNoStart = document.getElementById('f-orc-no-start').checked;
            const fNoEnd = document.getElementById('f-orc-no-end').checked;

            tb.innerHTML = '';
            listaOrcamentos.forEach(orc => {
                const lead = listaLeads.find(l => l.id === orc.lead_id);
                if(fLead && lead && !lead.nome_cliente_cache.toLowerCase().includes(fLead)) return;

                let histHtml = "";
                let refLeadHtml = "";
                let actionsColumnHtml = "";
                
                if(orc.historico_trabalhos) {
                    const reversedHist = [...orc.historico_trabalhos].reverse();
                    
                    reversedHist.forEach((h, idxInReversed) => {
                        const originalIdx = orc.historico_trabalhos.length - 1 - idxInReversed;
                        
                        if(fAtend !== 'todos' && h.atendente !== fAtend) return;
                        if(fStatus !== 'todos' && h.status !== fStatus) return;
                        if(fNoStart && h.inicio) return;
                        if(fNoEnd && h.fim) return;

                        refLeadHtml += `<div style="padding:10px; border-bottom:1px solid #eee; height:45px; display:flex; align-items:center;">Hist√≥rico #${h.hist_num}</div>`;
                        
                        histHtml += `
                            <div class="hist-mini-card" onclick="if(${currentPerms.orcamentos.gravar}) editarItemDoHistoricoList('${orc.id}', ${originalIdx})" style="margin-top:2px; height:45px; margin-right: 0; ${currentPerms.orcamentos.gravar?'':'cursor:default'}">
                                <div style="flex: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">
                                    <strong>${h.atendente}</strong> <span class="stage-tag">${h.status}</span> | 
                                    <small>In√≠cio: ${formatBR(h.inicio)} | Fim: ${formatBR(h.fim)}</small>
                                    ${h.prazo ? ' | <small style="color:red">üèÅ ' + formatBR(h.prazo) + '</small>' : ''}
                                </div>
                            </div>`;

                        const btnDup = currentPerms.orcamentos.gravar ? `<button class="btn-icon" title="Duplicar" onclick="event.stopPropagation(); duplicarItemHist('${orc.id}', ${originalIdx})">‚ûï</button>` : '';
                        const btnEdit = currentPerms.orcamentos.gravar ? `<button class="btn-icon" title="Editar este registro" onclick="event.stopPropagation(); editarItemDoHistoricoList('${orc.id}', ${originalIdx})">‚è±Ô∏è</button>` : '';
                        const btnDel = currentPerms.orcamentos.excluir ? `<button class="btn-icon" style="color:red" title="Excluir este registro" onclick="event.stopPropagation(); excluirItemHist('${orc.id}', ${originalIdx})">üóëÔ∏è</button>` : '';

                        actionsColumnHtml += `
                            <div style="height:45px; display:flex; align-items:center; justify-content:center; gap:5px; margin-top:2px; border-bottom:1px solid #eee; padding: 0 10px;">
                                ${btnDup} ${btnEdit} ${btnDel}
                            </div>`;
                    });
                }

                if (histHtml !== "") {
                    tb.innerHTML += `
                        <tr>
                            <td onclick="if(${currentPerms.orcamentos.ver}) carregarOrcamentoRaiz('${orc.id}')" style="vertical-align: middle; ${currentPerms.orcamentos.ver?'cursor:pointer':''}">
                                <b>${lead ? lead.nome_cliente_cache : ''}</b><br>
                                <small style="color:var(--primary)">${orc.id_externo || 'Sem ID'}</small>
                            </td>
                            <td style="vertical-align:top; padding:0;">${refLeadHtml}</td>
                            <td style="vertical-align:top; padding:0;">${histHtml}</td>
                            <td style="vertical-align:top; padding:0; text-align:center;">${actionsColumnHtml}</td>
                        </tr>`;
                }
            });
        };

        // Fun√ß√£o de controle de colunas do funil
        window.toggleFunnelCol = (colId) => {
            const el = document.getElementById('w-' + colId);
            const isChecked = document.getElementById('f-col-' + colId).checked;
            if (el) {
                el.style.display = isChecked ? 'flex' : 'none';
            }
        };

        window.renderFunnel = () => {
            if(!currentPerms || !currentPerms.funil_dash.ver) return;
            const cols = {novo:'list-novo', contatado:'list-contatado', orcamento:'list-orcamento', negociacao:'list-negociacao', fechado:'list-fechado', perdido:'list-perdido'};
            Object.values(cols).forEach(id => { const el=document.getElementById(id); if(el) el.innerHTML = ''; });
            const atend = document.getElementById('f-funil-atend').value;
            const dtIni = document.getElementById('f-funil-ini').value, dtFim = document.getElementById('f-funil-fim').value, fReal = document.getElementById('f-funil-real').value;
            const showAll = document.getElementById('f-funil-all').checked;

            listaLeads.forEach(lead => {
                const hist = lead.historico || [];
                const itemsToProcess = (hist.length > 0) ? (showAll ? hist : [hist[hist.length-1]]) : [{etapa: lead.etapa || 'novo', temperatura: ""}];
                itemsToProcess.forEach(h => {
                    if(atend !== 'todos' && h.atendente !== atend) return;
                    if(h.temperatura && !starFilters.includes(parseInt(h.temperatura))) return;
                    if(fReal === 'com' && !h.data_realizada) return;
                    if(fReal === 'sem' && h.data_realizada) return;
                    if(dtIni || dtFim) { if(!h.data_programada) return; const pDate = h.data_programada.split('T')[0]; if(dtIni && pDate < dtIni) return; if(dtFim && pDate > dtFim) return; }
                    const desde = lead.created_at ? new Date(lead.created_at.toDate()).toLocaleString('pt-BR') : '-';
                    let cor = '';
                    if(h.data_programada && !h.data_realizada) { cor = new Date(h.data_programada) < new Date() ? 'card-red' : 'card-blue'; } else if(h.data_realizada) cor = 'card-green';
                    
                    let statusOrcamentoStr = "";
                    if (h.etapa === 'orcamento') {
                        const orc = listaOrcamentos.find(o => o.lead_id === lead.id);
                        if (orc) statusOrcamentoStr = `<span class="status-badge-funnel">${orc.status}</span>`;
                    }

                    const div = document.getElementById(cols[h.etapa]);
                    if(div) {
                        div.innerHTML += `<div class="card ${cor}" onclick="if(${currentPerms.leads.ver}) editarLead('${lead.id}')"><span class="card-stars">${h.temperatura ? "‚≠ê".repeat(h.temperatura) : ""}</span><span class="card-title">${lead.nome_cliente_cache}</span><div class="card-dates"><b>Tipo:</b> ${h.contato_tipo || 'N/A'}<br><b>Desde:</b> ${desde}<br><b>Prog:</b> ${formatBR(h.data_programada)}<br><b>Real:</b> ${formatBR(h.data_realizada)}${statusOrcamentoStr ? '<br>'+statusOrcamentoStr : ''}</div></div>`;
                    }
                });
            });
            Object.keys(cols).forEach(key => { const count = document.getElementById(cols[key])?.children.length || 0; const badge = document.getElementById('c-' + key); if(badge) badge.innerText = count; });
        };

        window.renderTableLeads = () => {
            const tb = document.querySelector('#table-leads tbody'); 
            if(!tb || !currentPerms) return;
            tb.innerHTML = '';
            
            const fCli = document.getElementById('f-leads-cliente').value.toLowerCase();
            const fAtend = document.getElementById('f-leads-atend').value;
            const fOrigem = document.getElementById('f-leads-origem').value;
            const fEtapa = document.getElementById('f-leads-etapa').value;

            let leadsFiltered = listaLeads.filter(l => {
                const hist = l.historico || [];
                const lastH = hist.length ? hist[hist.length-1] : { etapa: l.etapa || 'novo', atendente: '' };
                const matchCli = l.nome_cliente_cache.toLowerCase().includes(fCli);
                const matchAtend = fAtend === 'todos' || lastH.atendente === fAtend;
                const matchOrigem = fOrigem === 'todos' || l.origem === fOrigem;
                const matchEtapa = fEtapa === 'todos' || lastH.etapa === fEtapa;
                return matchCli && matchAtend && matchOrigem && matchEtapa;
            });

            leadsFiltered.sort((a, b) => leadSortAsc ? a.nome_cliente_cache.localeCompare(b.nome_cliente_cache) : b.nome_cliente_cache.localeCompare(a.nome_cliente_cache));

            leadsFiltered.forEach(l => {
                const etapa = (l.historico && l.historico.length) ? l.historico[l.historico.length-1].etapa : 'novo';
                const desde = l.created_at ? new Date(l.created_at.toDate()).toLocaleString('pt-BR', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'}) : '-';
                const cliente = listaClientes.find(c => c.id === l.cliente_id);
                const tel = (cliente && cliente.telefone) ? cliente.telefone.replace(/\D/g, '') : '';
                
                const btnWhats = tel 
                    ? `<a href="https://wa.me/55${tel}" target="_blank" style="display:inline-flex; align-items:center; justify-content:center; width:30px; height:30px; text-decoration:none; font-size:1.1em;">üü¢</a>` 
                    : `<span style="display:inline-block; width:30px; height:30px;"></span>`;
                
                const btnEdit = currentPerms.leads.gravar ? `<button class="btn-icon" onclick="event.stopPropagation(); editarLead('${l.id}')">‚úèÔ∏è</button>` : '';
                const btnDel = currentPerms.leads.excluir ? `<button class="btn-icon" onclick="event.stopPropagation(); excluirLead('${l.id}')" style="color:red">üóëÔ∏è</button>` : '';

                tb.innerHTML += `<tr onclick="if(${currentPerms.leads.ver}) editarLead('${l.id}')">
                    <td>${desde}</td>
                    <td>${l.nome_cliente_cache}</td>
                    <td style="text-transform:capitalize">${etapa}</td>
                    <td>
                        <div class="actions-cell">
                            ${btnWhats} ${btnEdit} ${btnDel}
                        </div>
                    </td>
                </tr>`;
            });
        };

        // ========== RESTO DAS FUN√á√ïES GLOBAIS ==========
        window.addEventListener('paste', async (e) => {
            if (!leadAtual || document.getElementById('view-leads').style.display === 'none') return;
            if (!currentPerms.leads.gravar) return;
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf("image") !== -1) {
                    const blob = items[i].getAsFile();
                    const file = new File([blob], `print_${new Date().getTime()}.png`, { type: blob.type });
                    console.log("Imagem detectada no colar, iniciando upload...");
                    handleFileUpload([file]);
                }
            }
        });

        window.togglePrazoRequirement = (status) => {
            const inputPrazo = document.getElementById('apt-prazo-direto');
            const lblPrazo = document.getElementById('lbl-prazo-direto');
            if(status === 'Programado' || status === 'Solicitado Altera√ß√£o') {
                inputPrazo.required = true; lblPrazo.innerText = "Prazo Final *";
            } else {
                inputPrazo.required = false; lblPrazo.innerText = "Prazo Final";
            }
        };

        window.populateHistSelectDireto = (leadId) => {
            const sel = document.getElementById('apt-hist-ref-direto');
            sel.innerHTML = '<option value="">Selecione...</option>';
            const lead = listaLeads.find(l => l.id === leadId);
            if(lead && lead.historico) {
                lead.historico.forEach((h, idx) => {
                    if (h.etapa === 'orcamento') sel.innerHTML += `<option value="${idx + 1}">Hist√≥rico #${idx + 1} (${h.etapa})</option>`;
                });
            }
            const orc = listaOrcamentos.find(o => o.lead_id === leadId);
            if(orc) {
                document.getElementById('apt-orc-id-direto').value = orc.id;
                document.getElementById('apt-id-externo-direto').value = orc.id_externo || "";
            } else {
                document.getElementById('apt-orc-id-direto').value = "";
                document.getElementById('apt-id-externo-direto').value = "";
            }
        };

        window.checkRegistroDireto = (tipo) => {
            const indexEditing = parseInt(document.getElementById('apt-index-editing-direto').value);
            if(indexEditing === -1) return; 
            const campoData = document.getElementById('apt-' + tipo + '-direto').value;
            const campoReg = document.getElementById('apt-reg-' + tipo + '-direto');
            if(campoData && !campoReg.value) campoReg.value = new Date().toLocaleString('pt-BR');
        };

        document.getElementById('form-apontamento-direto').onsubmit = async (e) => {
            e.preventDefault();
            if(!currentPerms.orcamentos.gravar) return;
            const orcId = document.getElementById('apt-orc-id-direto').value;
            const leadId = document.getElementById('orc-lead-direto').value;
            const indexEditing = parseInt(document.getElementById('apt-index-editing-direto').value);
            
            const statusVal = document.getElementById('apt-status-direto').value;
            const inicioVal = document.getElementById('apt-inicio-direto').value;
            const regInicioVal = document.getElementById('apt-reg-inicio-direto').value;
            const fimVal = document.getElementById('apt-fim-direto').value;
            const regFimVal = document.getElementById('apt-reg-fim-direto').value;
            const prazoVal = document.getElementById('apt-prazo-direto').value;
            const atendenteVal = document.getElementById('apt-atendente-direto').value;

            if (indexEditing === -1) {
                if (inicioVal || regInicioVal || fimVal || regFimVal) {
                    alert("Para um NOVO Apontamento, os campos de Dia/Hora In√≠cio/Fim e seus Registros devem estar vazios. Registre o tempo apenas na altera√ß√£o de um registro j√° gravado.");
                    return;
                }
            }

            const statusPermitidosSemTrava = ['Programado', 'Solicitado Altera√ß√£o', 'Apresenta√ß√£o'];
            if (!statusPermitidosSemTrava.includes(statusVal)) {
                let aberto = false;
                listaOrcamentos.forEach(orc => {
                    if (orc.historico_trabalhos) {
                        orc.historico_trabalhos.forEach((h, idx) => {
                            if (orcId === orc.id && indexEditing === idx) return;
                            if (h.atendente === atendenteVal && h.inicio && !h.fim) aberto = true;
                        });
                    }
                });
                if (aberto) { alert(`O atendente ${atendenteVal} j√° possui um apontamento iniciado e n√£o finalizado.`); return; }
            }

            if ((statusVal === 'Programado' || statusVal === 'Solicitado Altera√ß√£o') && !prazoVal) {
                alert("O campo 'Prazo Final' √© obrigat√≥rio para o status selecionado."); return;
            }

            const item = { atendente: atendenteVal, hist_num: document.getElementById('apt-hist-ref-direto').value, id_externo: document.getElementById('apt-id-externo-direto').value, inicio: inicioVal, reg_inicio: regInicioVal || (inicioVal ? new Date().toLocaleString('pt-BR') : ""), fim: fimVal, reg_fim: regFimVal || (fimVal ? new Date().toLocaleString('pt-BR') : ""), prazo: prazoVal, status: statusVal, obs: document.getElementById('apt-obs-direto').value, timestamp: new Date().toISOString() };

            let historico = [];
            if (orcId) {
                const orcExistente = listaOrcamentos.find(o => o.id === orcId);
                historico = [...(orcExistente.historico_trabalhos || [])];
                if (indexEditing >= 0) historico[indexEditing] = item;
                else historico.push(item);
                await updateDoc(doc(db, "apontamentos", orcId), { historico_trabalhos: historico, status: item.status, atendente: item.atendente, id_externo: item.id_externo, data_prazo: item.prazo, updated_at: serverTimestamp() });
            } else {
                historico.push(item);
                await addDoc(collection(db, "apontamentos"), { lead_id: leadId, atendente: item.atendente, id_externo: item.id_externo, status: item.status, data_prazo: item.prazo, historico_trabalhos: historico, updated_at: serverTimestamp() });
            }
            alert("Apontamento gravado com sucesso!"); limparFormApontamentoDireto();
        };

        window.excluirItemHist = async (orcId, idx) => {
            if(!currentPerms.orcamentos.excluir) return;
            if(!confirm("Deseja excluir este registro de hist√≥rico espec√≠fico?")) return;
            const orc = listaOrcamentos.find(o => o.id === orcId); let novoHist = [...orc.historico_trabalhos]; novoHist.splice(idx, 1);
            if(novoHist.length === 0) await deleteDoc(doc(db, "apontamentos", orcId));
            else await updateDoc(doc(db, "apontamentos", orcId), { historico_trabalhos: novoHist, updated_at: serverTimestamp() });
        };

        window.duplicarItemHist = (orcId, idx) => {
            if(!currentPerms.orcamentos.gravar) return;
            const orc = listaOrcamentos.find(o => o.id === orcId); const h = orc.historico_trabalhos[idx];
            document.getElementById('orc-lead-direto').value = orc.lead_id; populateHistSelectDireto(orc.lead_id);
            document.getElementById('apt-orc-id-direto').value = orc.id; document.getElementById('apt-index-editing-direto').value = "-1";
            document.getElementById('apt-atendente-direto').value = h.atendente; document.getElementById('apt-hist-ref-direto').value = h.hist_num;
            document.getElementById('apt-id-externo-direto').value = h.id_externo || orc.id_externo || "";
            document.getElementById('apt-inicio-direto').value = ""; document.getElementById('apt-reg-inicio-direto').value = "";
            document.getElementById('apt-fim-direto').value = ""; document.getElementById('apt-reg-fim-direto').value = "";
            document.getElementById('apt-prazo-direto').value = h.prazo || ""; document.getElementById('apt-status-direto').value = h.status;
            document.getElementById('apt-obs-direto').value = h.obs || ""; togglePrazoRequirement(h.status);
            document.getElementById('form-apontamento-direto').scrollIntoView();
        };

        window.carregarOrcamentoRaiz = (id) => {
             const orc = listaOrcamentos.find(x => x.id === id);
             document.getElementById('orc-lead-direto').value = orc.lead_id; populateHistSelectDireto(orc.lead_id);
             document.getElementById('apt-orc-id-direto').value = orc.id; document.getElementById('apt-id-externo-direto').value = orc.id_externo || "";
        };

        window.editarItemDoHistoricoList = (orcId, idx) => {
            if(!currentPerms.orcamentos.gravar) return;
            const orc = listaOrcamentos.find(o => o.id === orcId); const h = orc.historico_trabalhos[idx];
            document.getElementById('orc-lead-direto').value = orc.lead_id; populateHistSelectDireto(orc.lead_id);
            document.getElementById('apt-orc-id-direto').value = orc.id; document.getElementById('apt-index-editing-direto').value = idx;
            document.getElementById('apt-atendente-direto').value = h.atendente; document.getElementById('apt-hist-ref-direto').value = h.hist_num;
            document.getElementById('apt-id-externo-direto').value = h.id_externo || orc.id_externo || "";
            document.getElementById('apt-inicio-direto').value = h.inicio || ""; document.getElementById('apt-reg-inicio-direto').value = h.reg_inicio || "";
            document.getElementById('apt-fim-direto').value = h.fim || ""; document.getElementById('apt-reg-fim-direto').value = h.reg_fim || "";
            document.getElementById('apt-prazo-direto').value = h.prazo || ""; document.getElementById('apt-status-direto').value = h.status;
            document.getElementById('apt-obs-direto').value = h.obs || ""; togglePrazoRequirement(h.status);
            document.getElementById('form-apontamento-direto').scrollIntoView();
        };

        window.limparFormApontamentoDireto = () => {
            document.getElementById('form-apontamento-direto').reset(); document.getElementById('apt-orc-id-direto').value = "";
            document.getElementById('apt-index-editing-direto').value = "-1"; document.getElementById('apt-reg-inicio-direto').value = "";
            document.getElementById('apt-reg-fim-direto').value = ""; togglePrazoRequirement('Programado');
        };

        window.abrirApontamento = (id, histNum = null) => {
            const orc = listaOrcamentos.find(x => x.id === id); if(!orc) return;
            const lead = listaLeads.find(l => l.id === orc.lead_id);
            document.getElementById('modal-info-lead').innerText = `Cliente: ${lead ? lead.nome_cliente_cache : '?'}`;
            const div = document.getElementById('lista-historico-apontamentos'); div.innerHTML = '';
            const histRefStr = histNum ? histNum.toString() : null; const lista = [...(orc.historico_trabalhos || [])].reverse();
            lista.forEach(h => {
                if(histRefStr && h.hist_num !== histRefStr) return;
                div.innerHTML += `<div class="hist-list-item"><strong>${h.atendente}</strong> <span class="stage-tag">${h.status}</span><br>In√≠cio: ${formatBR(h.inicio)} <small>(Reg: ${h.reg_inicio})</small><br>Fim: ${formatBR(h.fim)} <small>(Reg: ${h.reg_fim})</small><br>${h.prazo ? 'üèÅ <b>Prazo Final: ' + formatBR(h.prazo) + '</b><br>' : ''}<em>${h.obs || ''}</em></div>`;
            });
            document.getElementById('dialog-apontamento').showModal();
        };

        window.handleFileUpload = async (files) => {
            if(!leadAtual) return alert("Salve os dados b√°sicos antes de enviar arquivos.");
            const file = files[0]; if(!file) return;
            const path = `leads/${leadAtual.id}/${Date.now()}_${file.name}`; const storageRef = ref(storage, path);
            try { const snapshot = await uploadBytes(storageRef, file); const url = await getDownloadURL(snapshot.ref); const arquivos = leadAtual.arquivos || []; arquivos.push({ name: file.name, url: url, path: path }); await updateDoc(doc(db, "leads", leadAtual.id), { arquivos: arquivos }); console.log("Arquivo carregado com sucesso!"); } catch (err) { console.error(err); alert("Erro ao enviar arquivo."); } document.getElementById('lead-file-input').value = "";
        };

        window.renderArquivos = () => {
            const list = document.getElementById('lead-files-list'); list.innerHTML = "";
            if(!leadAtual || !leadAtual.arquivos) return;
            leadAtual.arquivos.forEach((file, idx) => {
                const btnDel = currentPerms.leads.excluir ? `<button class="btn-icon" onclick="excluirArquivo(${idx})" style="color:red">üóëÔ∏è</button>` : '';
                list.innerHTML += `<div class="file-item"><a href="${file.url}" target="_blank" class="file-name">${file.name}</a>${btnDel}</div>`;
            });
        };

        window.excluirArquivo = async (idx) => {
            if(!currentPerms.leads.excluir) return;
            if(!confirm("Excluir este arquivo permanentemente?")) return;
            const file = leadAtual.arquivos[idx]; const storageRef = ref(storage, file.path);
            try { await deleteObject(storageRef); const arquivos = [...leadAtual.arquivos]; arquivos.splice(idx, 1); await updateDoc(doc(db, "leads", leadAtual.id), { arquivos: arquivos }); } catch (err) { console.error(err); alert("Erro ao excluir arquivo."); }
        };

        window.handleHistContato = (val) => {
            const areaOutra = document.getElementById('area-contato-outra'); areaOutra.style.display = (val === 'Outra') ? 'block' : 'none'; let targetId = "";
            if(val === 'Propriet√°rio') targetId = leadAtual.cliente_id; else if(val === 'Arquiteto') targetId = leadAtual.arquiteto_id; else if(val === 'Respons√°vel Obra') targetId = leadAtual.responsavel_id; else if(val === 'Adm Obra') targetId = leadAtual.adm_obra_id; else if(val === 'Construtora') targetId = leadAtual.construtora_id;
            if(val !== 'Outra') updateHistContactDisplay(targetId);
        };

        window.updateHistContactDisplay = (id) => { const span = document.getElementById('info-hist-contato'); const item = listaClientes.find(c => c.id === id); span.innerHTML = item ? `${item.nome_empresa}<br>üìû ${item.telefone || '-'} | üìß ${item.email || '-'}` : "Contato n√£o vinculado."; };

        window.toggleLeadSort = () => { leadSortAsc = !leadSortAsc; renderTableLeads(); };

        window.processarDashboard = () => {
            if(!currentPerms || !currentPerms.funil_dash.ver_dash) return;
            const iniStr = document.getElementById('dash-inicio').value; const fimStr = document.getElementById('dash-fim').value; if(!iniStr || !fimStr) return;
            const ini = new Date(iniStr + "T00:00:00"), fim = new Date(fimStr + "T23:59:59"), atendente = document.getElementById('dash-atendente').value;
            const origemCount = {}, leadsDiaCount = {}, stageDurations = {}, cycleTimes = {contatado:[], orcamento:[], negociacao:[], fechado:[]}; let countPrazo=0, countAtraso=0, filteredData=[], totalDelayHours = 0;

            listaLeads.forEach(l => {
                const dtCriacao = l.created_at ? l.created_at.toDate() : null;
                if(dtCriacao && dtCriacao >= ini && dtCriacao <= fim) { origemCount[l.origem] = (origemCount[l.origem]||0)+1; const keyDay = dtCriacao.toLocaleDateString('pt-BR'); leadsDiaCount[keyDay] = (leadsDiaCount[keyDay]||0)+1; }
                if(l.historico) {
                    let lastDate = dtCriacao;
                    l.historico.forEach((h, idx) => {
                        const dataRef = h.data_realizada ? new Date(h.data_realizada) : (h.data_programada ? new Date(h.data_programada) : null);
                        if(dataRef) {
                            if(lastDate) { const diffDias = (dataRef - lastDate) / (1000*60*60*24); const prevEtapa = idx === 0 ? 'novo' : l.historico[idx-1].etapa; if(!stageDurations[prevEtapa]) stageDurations[prevEtapa] = []; stageDurations[prevEtapa].push(diffDias); }
                            if(dtCriacao && cycleTimes[h.etapa] !== undefined) cycleTimes[h.etapa].push((dataRef - dtCriacao) / (1000*60*60*24));
                            lastDate = dataRef;
                            if(atendente === 'todos' || h.atendente === atendente) {
                                if(dataRef >= ini && dataRef <= fim) {
                                    let isDelayed = false;
                                    if(h.data_programada && h.data_realizada) { const p = new Date(h.data_programada), r = new Date(h.data_realizada); if(r > p) { isDelayed = true; totalDelayHours += (r - p) / (1000*60*60); } }
                                    else if (h.data_programada && !h.data_realizada && new Date(h.data_programada) < new Date()) { isDelayed = true; totalDelayHours += (new Date() - new Date(h.data_programada)) / (1000*60*60); }
                                    if(isDelayed) countAtraso++; else countPrazo++;
                                    filteredData.push({id: l.id, dt: dataRef.toLocaleString('pt-BR'), etapa: h.etapa, cli: l.nome_cliente_cache, st: isDelayed ? 'Atrasado' : 'No Prazo'});
                                }
                            }
                        }
                    });
                }
            });
            const badge = document.getElementById('delay-metric');
            if(countAtraso > 0) { const avgDelay = totalDelayHours / countAtraso; const d = Math.floor(avgDelay/24), h = Math.floor(avgDelay % 24); badge.innerText = `‚è≥ Atraso M√©dio: ${d}d ${h}h`; badge.style.display = 'block'; } else badge.style.display = 'none';
            const stageMeans = Object.keys(stageDurations).map(k => ({etapa: k, media: (stageDurations[k].reduce((a,b)=>a+b,0) / stageDurations[k].length).toFixed(1)}));
            const cycleMeans = Object.keys(cycleTimes).map(k => cycleTimes[k].length ? (cycleTimes[k].reduce((a,b)=>a+b,0) / cycleTimes[k].length).toFixed(1) : 0);
            drawCharts(origemCount, leadsDiaCount, countPrazo, countAtraso, stageMeans, cycleMeans); renderDashTable(filteredData);
        };

        function drawCharts(origem, leadsDia, prazo, atraso, stageMeans, cycleMeans) {
            if(chartOrigem) chartOrigem.destroy(); chartOrigem = new Chart(document.getElementById('chartOrigem'), { type: 'bar', data: { labels: Object.keys(origem), datasets: [{ label: 'Leads', data: Object.values(origem), backgroundColor: '#007bff' }] }, options: { indexAxis: 'y', maintainAspectRatio: false } });
            if(chartLeadsDay) chartLeadsDay.destroy(); const keys = Object.keys(leadsDia).sort((a,b) => { const [d1,m1,y1]=a.split('/'); const [d2,m2,y2]=b.split('/'); return new Date(`${y1}-${m1}-${d1}`) - new Date(`${y2}-${m2}-${d2}`); }); chartLeadsDay = new Chart(document.getElementById('chartLeadsDay'), { type: 'bar', data: { labels: keys, datasets: [{ label: 'Novos Leads', data: keys.map(k=>leadsDia[k]), backgroundColor: '#28a745' }] }, options: { maintainAspectRatio: false } });
            if(chartPerf) chartPerf.destroy(); chartPerf = new Chart(document.getElementById('chartPerformance'), { type: 'doughnut', data: { labels: ['No Prazo', 'Atrasado'], datasets: [{ data: [prazo, atraso], backgroundColor: ['#28a745', '#dc3545'] }] }, options: { maintainAspectRatio: false } });
            if(chartStageTime) chartStageTime.destroy(); chartStageTime = new Chart(document.getElementById('chartStageTime'), { type: 'bar', data: { labels: stageMeans.map(m=>m.etapa), datasets: [{ label: 'Dias M√©dios', data: stageMeans.map(m=>m.media), backgroundColor: '#fd7e14' }] }, options: { maintainAspectRatio: false } });
            if(chartCycleTime) chartCycleTime.destroy(); chartCycleTime = new Chart(document.getElementById('chartCycleTime'), { type: 'line', data: { labels: ['Contato', 'Or√ßamento', 'Negocia√ß√£o', 'Fechado'], datasets: [{ label: 'Dias desde a cria√ß√£o', data: cycleMeans, borderColor: '#007bff', tension: 0.3, fill: true, backgroundColor: 'rgba(0,123,255,0.1)' }] }, options: { maintainAspectRatio: false } });
        }

        function renderDashTable(data) { const tb = document.querySelector('#dash-table tbody'); tb.innerHTML = ''; document.getElementById('dash-count').innerText = `(${data.length} registros)`; data.forEach(r => tb.innerHTML += `<tr onclick="if(${currentPerms.leads.ver}) editarLead('${r.id}')"><td>${r.dt}</td><td>${r.etapa}</td><td>${r.cli}</td><td>${r.st}</td></tr>`); }

        document.getElementById('form-historico').onsubmit = async(e) => {
            e.preventDefault(); if(!currentPerms.leads.gravar) return;
            const idx = document.getElementById('hist-index').value;
            const h = { atendente: document.getElementById('hist-atendente').value, contato_tipo: document.getElementById('hist-contato-tipo').value, contato_id: (document.getElementById('hist-contato-tipo').value === 'Outra') ? document.getElementById('hist-contato-id').value : "", etapa: document.getElementById('hist-etapa').value, data_programada: document.getElementById('hist-prog').value, data_realizada: document.getElementById('hist-real').value, resultado: document.getElementById('hist-resultado').value, resumo: document.getElementById('hist-resumo').value, temperatura: document.getElementById('hist-temp').value, data_operacao: new Date().toLocaleString('pt-BR') };
            if (h.etapa !== 'novo' && !h.temperatura) { alert("A classifica√ß√£o por estrelas √© obrigat√≥ria."); return; }
            if (h.data_realizada && !h.resultado) { alert("O Resultado √© obrigat√≥rio."); return; }
            let hist = [...(leadAtual.historico || [])];
            if(idx !== "") { h.updated_realizada_at = (hist[parseInt(idx)].data_realizada !== h.data_realizada) ? new Date().toLocaleString('pt-BR') : (hist[parseInt(idx)].updated_realizada_at || '-'); hist[parseInt(idx)] = h; } 
            else { h.updated_realizada_at = h.data_realizada ? new Date().toLocaleString('pt-BR') : '-'; hist.push(h); if (h.data_realizada && h.resultado === "Insucesso") { hist.push({ ...h, data_realizada: "", resultado: "", data_operacao: new Date().toLocaleString('pt-BR'), updated_realizada_at: '-', resumo: "REAGENDAMENTO AUTOM√ÅTICO: " + h.resumo }); } }
            await updateDoc(doc(db, "leads", leadAtual.id), { historico: hist, etapa: h.etapa });
            leadAtual.historico = hist; renderTimeline(); limparFormHist();
        };

        window.editHist = (i) => {
            if(!currentPerms.leads.gravar) return;
            const h = leadAtual.historico[i]; document.getElementById('hist-index').value = i; document.getElementById('hist-atendente').value = h.atendente; document.getElementById('hist-contato-tipo').value = h.contato_tipo || ""; handleHistContato(h.contato_tipo);
            if(h.contato_tipo === 'Outra') document.getElementById('hist-contato-id').value = h.contato_id || ""; document.getElementById('hist-etapa').value = h.etapa; document.getElementById('hist-temp').value = h.temperatura || ""; document.getElementById('hist-prog').value = h.data_programada || ''; document.getElementById('hist-real').value = h.data_realizada || ''; document.getElementById('hist-resultado').value = h.resultado || ''; document.getElementById('hist-resumo').value = h.resumo; document.getElementById('hist-upd-real').value = h.updated_realizada_at || '-'; document.getElementById('btn-save-hist').innerText = "Atualizar Intera√ß√£o";
        };

        window.novoHistBaseado = (i) => { if(!currentPerms.leads.gravar) return; const h = leadAtual.historico[i]; limparFormHist(); document.getElementById('hist-atendente').value = h.atendente; document.getElementById('hist-contato-tipo').value = h.contato_tipo || ""; handleHistContato(h.contato_tipo); document.getElementById('hist-etapa').value = h.etapa; document.getElementById('hist-temp').value = h.temperatura || ""; document.getElementById('btn-save-hist').innerText = "+ Gravar Intera√ß√£o"; document.getElementById('form-historico').scrollIntoView(); };
        window.switchView = (v) => { document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active')); document.getElementById('view-' + v).classList.add('active'); document.querySelectorAll('.nav-buttons button').forEach(b => b.classList.remove('active')); if(document.getElementById('btn-'+v)) document.getElementById('btn-'+v).classList.add('active'); if(v==='dashboard') processarDashboard(); };
        window.toggleStarFilter = (s) => { const i = starFilters.indexOf(s); if(i>-1) starFilters.splice(i,1); else starFilters.push(s); renderFunnel(); };
        window.limparFormLead = () => { document.getElementById('form-lead-main').reset(); document.getElementById('lead-id').value=''; document.getElementById('area-historico').style.display='none'; document.getElementById('area-arquivos').style.display='none'; leadAtual=null; document.querySelectorAll('.contact-info-display').forEach(s => s.innerText = ""); };
        window.limparFormHist = () => { document.getElementById('form-historico').reset(); document.getElementById('hist-index').value=''; document.getElementById('btn-save-hist').innerText = "+ Gravar Intera√ß√£o"; document.getElementById('info-hist-contato').innerText = ""; document.getElementById('area-contato-outra').style.display = "none"; };
        window.excluirLead = async(id) => { if(!currentPerms.leads.excluir) return; if(confirm("Excluir Lead?")) await deleteDoc(doc(db,"leads",id)); };
        window.novoLeadDireto = () => { if(!currentPerms.leads.gravar) return; window.switchView('leads'); window.limparFormLead(); };
        window.excluirCli = async(id) => { if(!currentPerms.cadastros.excluir) return; if(listaLeads.some(l => l.cliente_id === id)) return alert("Registro possui leads."); if(confirm("Excluir Registro?")) await deleteDoc(doc(db, "clientes", id)); };
        window.excluirAtend = async(id) => { if(!currentPerms.cadastros.excluir) return; const nome = listaAtendentes.find(a => a.id === id)?.nome; if(listaLeads.some(l => (l.historico || []).some(h => h.atendente === nome))) return alert("Atendente possui intera√ß√µes."); if(confirm("Excluir Atendente?")) await deleteDoc(doc(db, "atendentes", id)); };
        
        document.getElementById('form-cliente').onsubmit = async(e) => { 
            e.preventDefault(); if(!currentPerms.cadastros.gravar) return; const id=document.getElementById('cli-id').value, d={ nome_empresa:document.getElementById('cli-nome').value, tipo:document.getElementById('cli-tipo').value, status:document.getElementById('cli-status').value, telefone:document.getElementById('cli-telefone').value, email:document.getElementById('cli-email').value, cidade:document.getElementById('cli-cidade').value, endereco:document.getElementById('cli-endereco').value }; 
            if(id) await updateDoc(doc(db,"clientes",id),d); else await addDoc(collection(db,"clientes"),d); document.getElementById('form-cliente').reset(); document.getElementById('cli-id').value=''; 
        };
        
        document.getElementById('form-atendente').onsubmit = async(e) => { e.preventDefault(); if(!currentPerms.cadastros.gravar) return; const id=document.getElementById('atend-id').value, d={ nome:document.getElementById('atend-nome').value, email:document.getElementById('atend-email').value, whats:document.getElementById('atend-whats').value }; if(id) await updateDoc(doc(db,"atendentes",id),d); else await addDoc(collection(db,"atendentes"),d); document.getElementById('form-atendente').reset(); document.getElementById('atend-id').value=''; };
        
        document.getElementById('form-lead-main').onsubmit = async(e) => { 
            e.preventDefault(); if(!currentPerms.leads.gravar) return; const id=document.getElementById('lead-id').value, sel=document.getElementById('lead-cliente'), origem = document.getElementById('lead-origem').value, indicacao = document.getElementById('lead-indicacao').value;
            if(origem.toUpperCase().includes("INDICA√á√ÉO") && !indicacao) { alert("O campo Indica√ß√£o √© obrigat√≥rio."); return; }
            const d={ cliente_id:sel.value, nome_cliente_cache:sel.options[sel.selectedIndex].text, origem:origem, indicacao_id: indicacao, pvc_metragem: document.getElementById('lead-pvc-metragem').value, pvc_pecas: document.getElementById('lead-pvc-pecas').value, pvc_margem_padrao: document.getElementById('lead-pvc-margem-padrao').value, pvc_margem_especial: document.getElementById('lead-pvc-margem-especial').value, pvc_valor_orcamento: document.getElementById('lead-pvc-valor-orcamento').value, pvc_valor_pedido: document.getElementById('lead-pvc-valor-pedido').value, alu_metragem: document.getElementById('lead-alu-metragem').value, alu_pecas: document.getElementById('lead-alu-pecas').value, alu_margem_padrao: document.getElementById('lead-alu-margem-padrao').value, alu_margem_especial: document.getElementById('lead-alu-margem-especial').value, alu_valor_orcamento: document.getElementById('lead-alu-valor-orcamento').value, alu_valor_pedido: document.getElementById('lead-alu-valor-pedido').value, previsao:document.getElementById('lead-previsao').value, construtora_id: document.getElementById('lead-construtora').value, adm_obra_id: document.getElementById('lead-adm-obra').value, arquiteto_id: document.getElementById('lead-arquiteto').value, responsavel_id: document.getElementById('lead-responsavel').value, updated_at:serverTimestamp() }; 
            if(id) await updateDoc(doc(db,"leads",id),d); else { d.created_at=serverTimestamp(); d.etapa='novo'; await addDoc(collection(db,"leads"),d); } 
            alert('Dados Salvos!'); 
        };

        window.editarLead = (id) => { 
            leadAtual = listaLeads.find(l => l.id === id); switchView('leads'); document.getElementById('lead-id').value = id; 
            document.getElementById('lead-cliente').value = leadAtual.cliente_id; showInfo('cliente', leadAtual.cliente_id);
            document.getElementById('lead-origem').value = leadAtual.origem; document.getElementById('lead-indicacao').value = leadAtual.indicacao_id || ''; showInfo('indicacao', leadAtual.indicacao_id);
            document.getElementById('lead-pvc-metragem').value = leadAtual.pvc_metragem || ''; document.getElementById('lead-pvc-pecas').value = leadAtual.pvc_pecas || ''; document.getElementById('lead-pvc-margem-padrao').value = leadAtual.pvc_margem_padrao || ''; document.getElementById('lead-pvc-margem-especial').value = leadAtual.pvc_margem_especial || ''; document.getElementById('lead-pvc-valor-orcamento').value = leadAtual.pvc_valor_orcamento || ''; document.getElementById('lead-pvc-valor-pedido').value = leadAtual.pvc_valor_pedido || '';
            document.getElementById('lead-alu-metragem').value = leadAtual.alu_metragem || ''; document.getElementById('lead-alu-pecas').value = leadAtual.alu_pecas || ''; document.getElementById('lead-alu-margem-padrao').value = leadAtual.alu_margem_padrao || ''; document.getElementById('lead-alu-margem-especial').value = leadAtual.alu_margem_especial || ''; document.getElementById('lead-alu-valor-orcamento').value = leadAtual.alu_valor_orcamento || ''; document.getElementById('lead-alu-valor-pedido').value = leadAtual.alu_valor_pedido || '';
            document.getElementById('lead-previsao').value = leadAtual.previsao || ''; document.getElementById('lead-construtora').value = leadAtual.construtora_id || ''; showInfo('construtora', leadAtual.construtora_id); document.getElementById('lead-adm-obra').value = leadAtual.adm_obra_id || ''; showInfo('adm-obra', leadAtual.adm_obra_id); document.getElementById('lead-arquiteto').value = leadAtual.arquiteto_id || ''; showInfo('arquiteto', leadAtual.arquiteto_id); document.getElementById('lead-responsavel').value = leadAtual.responsavel_id || ''; showInfo('responsavel', leadAtual.responsavel_id);
            document.getElementById('area-historico').style.display = 'block'; document.getElementById('area-arquivos').style.display = 'block'; limparFormHist(); renderTimeline(); renderArquivos();
        };

        window.editarCli = (id) => { const c = listaClientes.find(x => x.id === id); switchView('cadastro'); document.getElementById('cli-id').value = c.id; document.getElementById('cli-nome').value = c.nome_empresa; document.getElementById('cli-tipo').value = c.tipo || 'Cliente'; document.getElementById('cli-status').value = c.status; document.getElementById('cli-telefone').value = c.telefone || ''; document.getElementById('cli-email').value = c.email || ''; document.getElementById('cli-cidade').value = c.cidade || ''; document.getElementById('cli-endereco').value = c.endereco || ''; };
        window.editarAtend = (id) => { const a = listaAtendentes.find(x => x.id === id); switchView('atendentes'); document.getElementById('atend-id').value = a.id; document.getElementById('atend-nome').value = a.nome; document.getElementById('atend-email').value = a.email; document.getElementById('atend-whats').value = a.whats || ''; };
        
        window.renderTimeline = () => { 
            const div = document.getElementById('timeline-list'); div.innerHTML = ''; const hArray = (leadAtual.historico || []).map((h, i) => ({...h, idx: i}));
            hArray.reverse().forEach((h, indexInTimeline) => { 
                const btnNovo = (indexInTimeline === 0 && currentPerms.leads.gravar) ? `<button class="btn-icon" onclick="novoHistBaseado(${h.idx})" title="Novo baseado neste">‚ûï</button>` : '';
                let targetId = (h.contato_tipo === 'Propriet√°rio') ? leadAtual.cliente_id : (h.contato_tipo === 'Arquiteto') ? leadAtual.arquiteto_id : (h.contato_tipo === 'Respons√°vel Obra') ? leadAtual.responsavel_id : (h.contato_tipo === 'Adm Obra') ? leadAtual.adm_obra_id : (h.contato_tipo === 'Construtora') ? leadAtual.construtora_id : h.contato_id;
                const contactData = listaClientes.find(c => c.id === targetId); const phone = contactData ? contactData.telefone.replace(/\D/g, '') : ''; const btnWhats = phone ? `<a href="https://wa.me/55${phone}" target="_blank" style="text-decoration:none; margin-left:10px; font-size:1.1em;">üü¢</a>` : '';
                
                let orcIntegrationHtml = '';
                if(h.etapa === 'orcamento') {
                    const orc = listaOrcamentos.find(o => o.lead_id === leadAtual.id);
                    if(orc) {
                        const histRefStr = (h.idx + 1).toString();
                        const linkedApts = (orc.historico_trabalhos || []).filter(apt => apt.hist_num === histRefStr);
                        if(linkedApts.length > 0) {
                            const lastApt = linkedApts[linkedApts.length - 1]; 
                             orcIntegrationHtml = `<div class="orc-integration-box" onclick="if(${currentPerms.orcamentos.ver}) abrirApontamento('${orc.id}', ${h.idx + 1})"><b>‚è±Ô∏è Apontamento:</b> ${lastApt.status} | üë§ ${lastApt.atendente}<br>üìÖ In√≠cio: ${formatBR(lastApt.inicio)} | Fim: ${formatBR(lastApt.fim)}</div>`;
                        }
                    }
                }

                const btnEdit = currentPerms.leads.gravar ? `<button class="btn-icon" onclick="editHist(${h.idx})">‚úèÔ∏è</button>` : '';
                const btnDel = currentPerms.leads.excluir ? `<button class="btn-del-hist" onclick="delHist(${h.idx})">üóëÔ∏è</button>` : '';

                div.innerHTML += `<div class="timeline-item">
                    <div class="seq-badge">${h.idx + 1}</div>
                    <div class="tl-header"><span class="stage-tag">${h.etapa}</span><div>${btnEdit}${btnNovo}${btnDel}</div></div>
                    <span style="font-size:0.8em; color:var(--primary); font-weight:bold;">üë§ ${h.atendente}</span><br>
                    <span style="font-size:0.75em; color:#666">üìû Contato: ${h.contato_tipo || 'N/A'} ${btnWhats} | üèÅ Status: ${h.resultado || '-'}</span>
                    <div onclick="if(${currentPerms.leads.gravar}) editHist(${h.idx})" style="cursor:${currentPerms.leads.gravar?'pointer':'default'}; margin-top:5px;"><b>Prog:</b> ${formatBR(h.data_programada)} | <b>Real:</b> ${formatBR(h.data_realizada)} <span style="color:#ffc107">${h.temperatura ? "‚≠ê".repeat(h.temperatura) : ""}</span><br><i>${h.resumo}</i></div>
                    ${orcIntegrationHtml}
                </div>`; 
            }); 
        };

        window.delHist = async (i) => { if(!currentPerms.leads.excluir) return; if(!confirm("Excluir esta intera√ß√£o?")) return; let hist = [...leadAtual.historico]; hist.splice(i, 1); const ultEtapa = hist.length ? hist[hist.length-1].etapa : 'novo'; await updateDoc(doc(db, "leads", leadAtual.id), { historico: hist, etapa: ultEtapa }); leadAtual.historico = hist; renderTimeline(); };
        
        // ========== FUN√á√ïES TELA DE USU√ÅRIOS ==========
        window.renderTableUsuarios = () => {
            const tb = document.querySelector('#table-usuarios tbody');
            if(!tb) return;
            tb.innerHTML = '';
            listaUsuarios.forEach(u => {
                tb.innerHTML += `<tr onclick="editarUsuarioConfig('${u.uid}')" style="cursor:pointer;">
                    <td>${u.email}</td>
                    <td>${u.perfil === 'admin' ? 'admin' : 'user'}</td>
                    <td style="text-align:center;"><button class="btn-icon" onclick="event.stopPropagation(); editarUsuarioConfig('${u.uid}')">‚öôÔ∏è</button></td>
                </tr>`;
            });
        };

        window.editarUsuarioConfig = (uid) => {
            const u = listaUsuarios.find(x => x.uid === uid);
            if(!u) return;
            document.getElementById('perm-user-uid').value = u.uid;
            document.getElementById('perm-user-email').value = u.email;
            document.getElementById('perm-user-perfil').value = u.perfil;
            
            const p = u.permissoes || defaultPermissoes;
            document.getElementById('p-funil-ver').checked = p.funil_dash?.ver || false;
            document.getElementById('p-dash-ver').checked = p.funil_dash?.ver_dash || false;
            
            document.getElementById('p-leads-ver').checked = p.leads?.ver || false;
            document.getElementById('p-leads-gravar').checked = p.leads?.gravar || false;
            document.getElementById('p-leads-excluir').checked = p.leads?.excluir || false;
            
            document.getElementById('p-orc-ver').checked = p.orcamentos?.ver || false;
            document.getElementById('p-orc-gravar').checked = p.orcamentos?.gravar || false;
            document.getElementById('p-orc-excluir').checked = p.orcamentos?.excluir || false;
            
            document.getElementById('p-cad-ver').checked = p.cadastros?.ver || false;
            document.getElementById('p-cad-gravar').checked = p.cadastros?.gravar || false;
            document.getElementById('p-cad-excluir').checked = p.cadastros?.excluir || false;
            
            // Re-aplicar a trava visual do formul√°rio de acordo com o perfil carregado
            const area = document.getElementById('area-config-perms');
            if(u.perfil === 'admin') {
                area.style.opacity = '0.5'; area.style.pointerEvents = 'none';
            } else {
                area.style.opacity = '1'; area.style.pointerEvents = 'auto';
            }
        };

        document.getElementById('form-permissoes').addEventListener('submit', async (e) => {
            e.preventDefault();
            const uid = document.getElementById('perm-user-uid').value;
            if(!uid) return alert("Selecione um usu√°rio na lista primeiro.");
            
            const perfil = document.getElementById('perm-user-perfil').value;
            
            // Prote√ß√£o para evitar remover o √∫ltimo administrador do sistema
            const userTarget = listaUsuarios.find(x => x.uid === uid);
            if (userTarget && userTarget.perfil === 'admin' && perfil !== 'admin') {
                const totalAdmins = listaUsuarios.filter(x => x.perfil === 'admin').length;
                if (totalAdmins <= 1) {
                    return alert("N√£o √© poss√≠vel alterar o perfil deste usu√°rio para Padr√£o! O sistema precisa manter pelo menos 1 (um) Administrador ativo.");
                }
            }
            
            let p = {
                funil_dash: { ver: document.getElementById('p-funil-ver').checked, ver_dash: document.getElementById('p-dash-ver').checked },
                leads: { ver: document.getElementById('p-leads-ver').checked, gravar: document.getElementById('p-leads-gravar').checked, excluir: document.getElementById('p-leads-excluir').checked },
                orcamentos: { ver: document.getElementById('p-orc-ver').checked, gravar: document.getElementById('p-orc-gravar').checked, excluir: document.getElementById('p-orc-excluir').checked },
                cadastros: { ver: document.getElementById('p-cad-ver').checked, gravar: document.getElementById('p-cad-gravar').checked, excluir: document.getElementById('p-cad-excluir').checked }
            };

            if(perfil === 'admin') p = adminPermissoes; // Trava m√°xima de seguran√ßa pro UI se for admin

            await updateDoc(doc(db, "usuarios", uid), { perfil: perfil, permissoes: p, updated_at: serverTimestamp() });
            alert("Permiss√µes salvas com sucesso!");
        });

        document.getElementById('perm-user-perfil').addEventListener('change', (e) => {
            const area = document.getElementById('area-config-perms');
            if(e.target.value === 'admin') {
                area.style.opacity = '0.5'; area.style.pointerEvents = 'none'; // Desabilita checkboxes
                area.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = true);
            } else {
                area.style.opacity = '1'; area.style.pointerEvents = 'auto'; // Habilita
            }
        });

        window.removerUsuarioFirestore = async () => {
            const uid = document.getElementById('perm-user-uid').value;
            if(!uid) return alert("Selecione um usu√°rio na lista primeiro.");
            
            // Prote√ß√£o para evitar apagar o √∫ltimo administrador do sistema
            const userTarget = listaUsuarios.find(x => x.uid === uid);
            if (userTarget && userTarget.perfil === 'admin') {
                const totalAdmins = listaUsuarios.filter(x => x.perfil === 'admin').length;
                if (totalAdmins <= 1) {
                    return alert("N√£o √© poss√≠vel remover este usu√°rio! O sistema precisa manter pelo menos 1 (um) Administrador ativo.");
                }
            }
            
            if(confirm("Remover o acesso deste usu√°rio?\nIsso apagar√° suas permiss√µes do Firestore. (Sua conta Firebase Auth ainda existir√°, mas sem acesso)")) {
                await deleteDoc(doc(db, "usuarios", uid));
                document.getElementById('form-permissoes').reset();
                document.getElementById('perm-user-uid').value = '';
                
                // Se a pessoa excluiu a si mesma, sai do sistema
                if (currentUser && uid === currentUser.uid) {
                    logoutApp();
                } else {
                    alert("Acesso removido.");
                }
            }
        };

        window.onload = () => { const h = new Date(); document.getElementById('dash-inicio').value = new Date(h.getFullYear(), h.getMonth(), 1).toISOString().split('T')[0]; document.getElementById('dash-fim').value = h.toISOString().split('T')[0]; applyMasks(); togglePrazoRequirement('Programado'); };
    </script>
</body>
</html>
